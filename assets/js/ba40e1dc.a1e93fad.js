"use strict";(globalThis.webpackChunkwebsite=globalThis.webpackChunkwebsite||[]).push([[83513],{28453:(e,n,s)=>{s.d(n,{R:()=>a,x:()=>o});var t=s(96540);const i={},r=t.createContext(i);function a(e){const n=t.useContext(r);return t.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function o(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:a(e.components),t.createElement(r.Provider,{value:n},e.children)}},60626:(e,n,s)=>{s.r(n),s.d(n,{assets:()=>c,contentTitle:()=>o,default:()=>p,frontMatter:()=>a,metadata:()=>t,toc:()=>l});const t=JSON.parse('{"id":"skills/indie_monetization_strategist/references/stripe-integration","title":"Complete Stripe Integration Guide","description":"Step-by-step guide for adding payments to indie projects.","source":"@site/docs/skills/indie_monetization_strategist/references/stripe-integration.md","sourceDirName":"skills/indie_monetization_strategist/references","slug":"/skills/indie_monetization_strategist/references/stripe-integration","permalink":"/docs/skills/indie_monetization_strategist/references/stripe-integration","draft":false,"unlisted":false,"tags":[],"version":"current","sidebarPosition":3,"frontMatter":{"title":"Complete Stripe Integration Guide","sidebar_label":"Complete Stripe Integration...","sidebar_position":3},"sidebar":"tutorialSidebar","previous":{"title":"Pricing Page Templates","permalink":"/docs/skills/indie_monetization_strategist/references/pricing-templates"},"next":{"title":"Seo Visibility Expert","permalink":"/docs/skills/seo_visibility_expert/"}}');var i=s(74848),r=s(28453);const a={title:"Complete Stripe Integration Guide",sidebar_label:"Complete Stripe Integration...",sidebar_position:3},o="Complete Stripe Integration Guide",c={},l=[{value:"Quick Start Checklist",id:"quick-start-checklist",level:2},{value:"1. Environment Setup",id:"1-environment-setup",level:2},{value:"Install Dependencies",id:"install-dependencies",level:3},{value:"Environment Variables",id:"environment-variables",level:3},{value:"2. One-Time Payment (Checkout Sessions)",id:"2-one-time-payment-checkout-sessions",level:2},{value:"Create Checkout Session (Next.js API Route)",id:"create-checkout-session-nextjs-api-route",level:3},{value:"Frontend Checkout Button",id:"frontend-checkout-button",level:3},{value:"3. Subscription Payments",id:"3-subscription-payments",level:2},{value:"Create Subscription Checkout",id:"create-subscription-checkout",level:3},{value:"Customer Portal (Manage Subscriptions)",id:"customer-portal-manage-subscriptions",level:3},{value:"4. Webhook Handler",id:"4-webhook-handler",level:2},{value:"Set Up Webhooks",id:"set-up-webhooks",level:3},{value:"5. Testing",id:"5-testing",level:2},{value:"Test Mode",id:"test-mode",level:3},{value:"Test Card Numbers",id:"test-card-numbers",level:3},{value:"Test Webhooks Locally",id:"test-webhooks-locally",level:3},{value:"6. Production Checklist",id:"6-production-checklist",level:2},{value:"Before Going Live",id:"before-going-live",level:3},{value:"Security",id:"security",level:3},{value:"Legal",id:"legal",level:3},{value:"Common Patterns",id:"common-patterns",level:2},{value:"Check Subscription Status",id:"check-subscription-status",level:3},{value:"Usage-Based Billing",id:"usage-based-billing",level:3},{value:"Proration on Plan Changes",id:"proration-on-plan-changes",level:3}];function d(e){const n={code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",input:"input",li:"li",p:"p",pre:"pre",ul:"ul",...(0,r.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(n.header,{children:(0,i.jsx)(n.h1,{id:"complete-stripe-integration-guide",children:"Complete Stripe Integration Guide"})}),"\n",(0,i.jsx)(n.p,{children:"Step-by-step guide for adding payments to indie projects."}),"\n",(0,i.jsx)(n.h2,{id:"quick-start-checklist",children:"Quick Start Checklist"}),"\n",(0,i.jsxs)(n.ul,{className:"contains-task-list",children:["\n",(0,i.jsxs)(n.li,{className:"task-list-item",children:[(0,i.jsx)(n.input,{type:"checkbox",disabled:!0})," ","Create Stripe account (stripe.com)"]}),"\n",(0,i.jsxs)(n.li,{className:"task-list-item",children:[(0,i.jsx)(n.input,{type:"checkbox",disabled:!0})," ","Get API keys (Dashboard \u2192 Developers \u2192 API keys)"]}),"\n",(0,i.jsxs)(n.li,{className:"task-list-item",children:[(0,i.jsx)(n.input,{type:"checkbox",disabled:!0})," ","Create products and prices (Dashboard \u2192 Products)"]}),"\n",(0,i.jsxs)(n.li,{className:"task-list-item",children:[(0,i.jsx)(n.input,{type:"checkbox",disabled:!0})," ","Implement checkout flow"]}),"\n",(0,i.jsxs)(n.li,{className:"task-list-item",children:[(0,i.jsx)(n.input,{type:"checkbox",disabled:!0})," ","Set up webhooks for fulfillment"]}),"\n",(0,i.jsxs)(n.li,{className:"task-list-item",children:[(0,i.jsx)(n.input,{type:"checkbox",disabled:!0})," ","Test with test mode keys"]}),"\n",(0,i.jsxs)(n.li,{className:"task-list-item",children:[(0,i.jsx)(n.input,{type:"checkbox",disabled:!0})," ","Switch to live keys when ready"]}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"1-environment-setup",children:"1. Environment Setup"}),"\n",(0,i.jsx)(n.h3,{id:"install-dependencies",children:"Install Dependencies"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"# Node.js\nnpm install stripe @stripe/stripe-js\n\n# Python\npip install stripe\n\n# Ruby\ngem install stripe\n"})}),"\n",(0,i.jsx)(n.h3,{id:"environment-variables",children:"Environment Variables"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"# .env.local (never commit this!)\nSTRIPE_SECRET_KEY=sk_test_xxxxx\nSTRIPE_PUBLISHABLE_KEY=pk_test_xxxxx\nSTRIPE_WEBHOOK_SECRET=whsec_xxxxx\nNEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY=pk_test_xxxxx\n"})}),"\n",(0,i.jsx)(n.h2,{id:"2-one-time-payment-checkout-sessions",children:"2. One-Time Payment (Checkout Sessions)"}),"\n",(0,i.jsx)(n.h3,{id:"create-checkout-session-nextjs-api-route",children:"Create Checkout Session (Next.js API Route)"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-typescript",children:"// pages/api/checkout.ts\nimport Stripe from 'stripe';\nimport { NextApiRequest, NextApiResponse } from 'next';\n\nconst stripe = new Stripe(process.env.STRIPE_SECRET_KEY!, {\n  apiVersion: '2024-04-10',\n});\n\nexport default async function handler(\n  req: NextApiRequest,\n  res: NextApiResponse\n) {\n  if (req.method !== 'POST') {\n    return res.status(405).json({ error: 'Method not allowed' });\n  }\n\n  const { priceId, email } = req.body;\n\n  try {\n    const session = await stripe.checkout.sessions.create({\n      mode: 'payment',\n      payment_method_types: ['card'],\n      line_items: [\n        {\n          price: priceId,\n          quantity: 1,\n        },\n      ],\n      customer_email: email,\n      success_url: `${process.env.NEXT_PUBLIC_URL}/success?session_id={CHECKOUT_SESSION_ID}`,\n      cancel_url: `${process.env.NEXT_PUBLIC_URL}/pricing`,\n      metadata: {\n        // Add custom data here for webhook processing\n        userId: req.body.userId,\n      },\n    });\n\n    res.json({ url: session.url });\n  } catch (error) {\n    console.error('Stripe checkout error:', error);\n    res.status(500).json({ error: 'Failed to create checkout session' });\n  }\n}\n"})}),"\n",(0,i.jsx)(n.h3,{id:"frontend-checkout-button",children:"Frontend Checkout Button"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-typescript",children:"// components/CheckoutButton.tsx\n'use client';\n\nimport { useState } from 'react';\nimport { loadStripe } from '@stripe/stripe-js';\n\nconst stripePromise = loadStripe(\n  process.env.NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY!\n);\n\nexport function CheckoutButton({ priceId }: { priceId: string }) {\n  const [loading, setLoading] = useState(false);\n\n  const handleCheckout = async () => {\n    setLoading(true);\n\n    try {\n      const response = await fetch('/api/checkout', {\n        method: 'POST',\n        headers: { 'Content-Type': 'application/json' },\n        body: JSON.stringify({ priceId }),\n      });\n\n      const { url } = await response.json();\n      window.location.href = url;\n    } catch (error) {\n      console.error('Checkout error:', error);\n      setLoading(false);\n    }\n  };\n\n  return (\n    <button\n      onClick={handleCheckout}\n      disabled={loading}\n      className=\"btn-primary\"\n    >\n      {loading ? 'Loading...' : 'Buy Now'}\n    </button>\n  );\n}\n"})}),"\n",(0,i.jsx)(n.h2,{id:"3-subscription-payments",children:"3. Subscription Payments"}),"\n",(0,i.jsx)(n.h3,{id:"create-subscription-checkout",children:"Create Subscription Checkout"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-typescript",children:"// pages/api/subscribe.ts\nimport Stripe from 'stripe';\n\nconst stripe = new Stripe(process.env.STRIPE_SECRET_KEY!);\n\nexport default async function handler(req, res) {\n  const { priceId, email, customerId } = req.body;\n\n  try {\n    const session = await stripe.checkout.sessions.create({\n      mode: 'subscription',\n      payment_method_types: ['card'],\n      line_items: [\n        {\n          price: priceId,\n          quantity: 1,\n        },\n      ],\n      customer: customerId, // Existing customer\n      customer_email: customerId ? undefined : email, // Or new customer\n      success_url: `${process.env.NEXT_PUBLIC_URL}/dashboard?session_id={CHECKOUT_SESSION_ID}`,\n      cancel_url: `${process.env.NEXT_PUBLIC_URL}/pricing`,\n      subscription_data: {\n        trial_period_days: 14, // Optional free trial\n        metadata: {\n          userId: req.body.userId,\n        },\n      },\n    });\n\n    res.json({ url: session.url });\n  } catch (error) {\n    res.status(500).json({ error: error.message });\n  }\n}\n"})}),"\n",(0,i.jsx)(n.h3,{id:"customer-portal-manage-subscriptions",children:"Customer Portal (Manage Subscriptions)"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-typescript",children:"// pages/api/portal.ts\nimport Stripe from 'stripe';\n\nconst stripe = new Stripe(process.env.STRIPE_SECRET_KEY!);\n\nexport default async function handler(req, res) {\n  const { customerId } = req.body;\n\n  try {\n    const session = await stripe.billingPortal.sessions.create({\n      customer: customerId,\n      return_url: `${process.env.NEXT_PUBLIC_URL}/dashboard`,\n    });\n\n    res.json({ url: session.url });\n  } catch (error) {\n    res.status(500).json({ error: error.message });\n  }\n}\n"})}),"\n",(0,i.jsx)(n.h2,{id:"4-webhook-handler",children:"4. Webhook Handler"}),"\n",(0,i.jsx)(n.h3,{id:"set-up-webhooks",children:"Set Up Webhooks"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-typescript",children:"// pages/api/webhooks/stripe.ts\nimport Stripe from 'stripe';\nimport { buffer } from 'micro';\n\nconst stripe = new Stripe(process.env.STRIPE_SECRET_KEY!);\n\nexport const config = {\n  api: {\n    bodyParser: false, // Required for webhook signature verification\n  },\n};\n\nexport default async function handler(req, res) {\n  if (req.method !== 'POST') {\n    return res.status(405).json({ error: 'Method not allowed' });\n  }\n\n  const buf = await buffer(req);\n  const sig = req.headers['stripe-signature']!;\n\n  let event: Stripe.Event;\n\n  try {\n    event = stripe.webhooks.constructEvent(\n      buf,\n      sig,\n      process.env.STRIPE_WEBHOOK_SECRET!\n    );\n  } catch (err) {\n    console.error('Webhook signature verification failed:', err);\n    return res.status(400).send(`Webhook Error: ${err.message}`);\n  }\n\n  // Handle specific events\n  switch (event.type) {\n    case 'checkout.session.completed': {\n      const session = event.data.object as Stripe.Checkout.Session;\n      await handleCheckoutComplete(session);\n      break;\n    }\n\n    case 'customer.subscription.created': {\n      const subscription = event.data.object as Stripe.Subscription;\n      await handleSubscriptionCreated(subscription);\n      break;\n    }\n\n    case 'customer.subscription.updated': {\n      const subscription = event.data.object as Stripe.Subscription;\n      await handleSubscriptionUpdated(subscription);\n      break;\n    }\n\n    case 'customer.subscription.deleted': {\n      const subscription = event.data.object as Stripe.Subscription;\n      await handleSubscriptionCanceled(subscription);\n      break;\n    }\n\n    case 'invoice.payment_succeeded': {\n      const invoice = event.data.object as Stripe.Invoice;\n      await handlePaymentSucceeded(invoice);\n      break;\n    }\n\n    case 'invoice.payment_failed': {\n      const invoice = event.data.object as Stripe.Invoice;\n      await handlePaymentFailed(invoice);\n      break;\n    }\n\n    default:\n      console.log(`Unhandled event type: ${event.type}`);\n  }\n\n  res.json({ received: true });\n}\n\n// Handler functions\nasync function handleCheckoutComplete(session: Stripe.Checkout.Session) {\n  const userId = session.metadata?.userId;\n  const customerId = session.customer as string;\n\n  // Grant access to purchased product\n  await db.users.update({\n    where: { id: userId },\n    data: {\n      stripeCustomerId: customerId,\n      hasPurchased: true,\n      purchasedAt: new Date(),\n    },\n  });\n\n  // Send confirmation email\n  await sendEmail({\n    to: session.customer_email!,\n    template: 'purchase-confirmation',\n    data: { session },\n  });\n}\n\nasync function handleSubscriptionCreated(subscription: Stripe.Subscription) {\n  const customerId = subscription.customer as string;\n  const priceId = subscription.items.data[0].price.id;\n\n  await db.subscriptions.create({\n    data: {\n      stripeCustomerId: customerId,\n      stripeSubscriptionId: subscription.id,\n      stripePriceId: priceId,\n      status: subscription.status,\n      currentPeriodEnd: new Date(subscription.current_period_end * 1000),\n    },\n  });\n}\n\nasync function handleSubscriptionUpdated(subscription: Stripe.Subscription) {\n  await db.subscriptions.update({\n    where: { stripeSubscriptionId: subscription.id },\n    data: {\n      status: subscription.status,\n      stripePriceId: subscription.items.data[0].price.id,\n      currentPeriodEnd: new Date(subscription.current_period_end * 1000),\n    },\n  });\n}\n\nasync function handleSubscriptionCanceled(subscription: Stripe.Subscription) {\n  await db.subscriptions.update({\n    where: { stripeSubscriptionId: subscription.id },\n    data: {\n      status: 'canceled',\n      canceledAt: new Date(),\n    },\n  });\n\n  // Send cancellation email\n  const customer = await stripe.customers.retrieve(\n    subscription.customer as string\n  );\n  if (customer.email) {\n    await sendEmail({\n      to: customer.email,\n      template: 'subscription-canceled',\n    });\n  }\n}\n\nasync function handlePaymentFailed(invoice: Stripe.Invoice) {\n  const subscription = await stripe.subscriptions.retrieve(\n    invoice.subscription as string\n  );\n\n  // Send payment failed email\n  await sendEmail({\n    to: invoice.customer_email!,\n    template: 'payment-failed',\n    data: {\n      amountDue: invoice.amount_due / 100,\n      updatePaymentUrl: `${process.env.NEXT_PUBLIC_URL}/update-payment`,\n    },\n  });\n}\n"})}),"\n",(0,i.jsx)(n.h2,{id:"5-testing",children:"5. Testing"}),"\n",(0,i.jsx)(n.h3,{id:"test-mode",children:"Test Mode"}),"\n",(0,i.jsx)(n.p,{children:"Always use test keys during development:"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"sk_test_..."})," for secret key"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"pk_test_..."})," for publishable key"]}),"\n"]}),"\n",(0,i.jsx)(n.h3,{id:"test-card-numbers",children:"Test Card Numbers"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:"# Successful payments\n4242424242424242 - Visa (success)\n5555555555554444 - Mastercard (success)\n\n# Declined payments\n4000000000000002 - Card declined\n4000000000009995 - Insufficient funds\n\n# 3D Secure\n4000002500003155 - Requires authentication\n\n# Use any future expiry date\n# Use any 3-digit CVC\n"})}),"\n",(0,i.jsx)(n.h3,{id:"test-webhooks-locally",children:"Test Webhooks Locally"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"# Install Stripe CLI\nbrew install stripe/stripe-cli/stripe\n\n# Login\nstripe login\n\n# Forward webhooks to local server\nstripe listen --forward-to localhost:3000/api/webhooks/stripe\n\n# Copy the webhook secret (whsec_xxx) to .env.local\n"})}),"\n",(0,i.jsx)(n.h2,{id:"6-production-checklist",children:"6. Production Checklist"}),"\n",(0,i.jsx)(n.h3,{id:"before-going-live",children:"Before Going Live"}),"\n",(0,i.jsxs)(n.ul,{className:"contains-task-list",children:["\n",(0,i.jsxs)(n.li,{className:"task-list-item",children:[(0,i.jsx)(n.input,{type:"checkbox",disabled:!0})," ","Switch to live API keys"]}),"\n",(0,i.jsxs)(n.li,{className:"task-list-item",children:[(0,i.jsx)(n.input,{type:"checkbox",disabled:!0})," ","Set up production webhook endpoint"]}),"\n",(0,i.jsxs)(n.li,{className:"task-list-item",children:[(0,i.jsx)(n.input,{type:"checkbox",disabled:!0})," ","Test complete purchase flow"]}),"\n",(0,i.jsxs)(n.li,{className:"task-list-item",children:[(0,i.jsx)(n.input,{type:"checkbox",disabled:!0})," ","Verify webhook handling for all event types"]}),"\n",(0,i.jsxs)(n.li,{className:"task-list-item",children:[(0,i.jsx)(n.input,{type:"checkbox",disabled:!0})," ","Set up error alerting (Sentry, etc.)"]}),"\n",(0,i.jsxs)(n.li,{className:"task-list-item",children:[(0,i.jsx)(n.input,{type:"checkbox",disabled:!0})," ","Configure Stripe receipts and invoices"]}),"\n",(0,i.jsxs)(n.li,{className:"task-list-item",children:[(0,i.jsx)(n.input,{type:"checkbox",disabled:!0})," ","Add refund handling logic"]}),"\n",(0,i.jsxs)(n.li,{className:"task-list-item",children:[(0,i.jsx)(n.input,{type:"checkbox",disabled:!0})," ","Set up tax collection if needed (Stripe Tax)"]}),"\n"]}),"\n",(0,i.jsx)(n.h3,{id:"security",children:"Security"}),"\n",(0,i.jsxs)(n.ul,{className:"contains-task-list",children:["\n",(0,i.jsxs)(n.li,{className:"task-list-item",children:[(0,i.jsx)(n.input,{type:"checkbox",disabled:!0})," ","Never expose secret key to client"]}),"\n",(0,i.jsxs)(n.li,{className:"task-list-item",children:[(0,i.jsx)(n.input,{type:"checkbox",disabled:!0})," ","Verify webhook signatures"]}),"\n",(0,i.jsxs)(n.li,{className:"task-list-item",children:[(0,i.jsx)(n.input,{type:"checkbox",disabled:!0})," ","Use environment variables for all keys"]}),"\n",(0,i.jsxs)(n.li,{className:"task-list-item",children:[(0,i.jsx)(n.input,{type:"checkbox",disabled:!0})," ","Enable 3D Secure for fraud prevention"]}),"\n",(0,i.jsxs)(n.li,{className:"task-list-item",children:[(0,i.jsx)(n.input,{type:"checkbox",disabled:!0})," ","Set up Radar rules for fraud detection"]}),"\n"]}),"\n",(0,i.jsx)(n.h3,{id:"legal",children:"Legal"}),"\n",(0,i.jsxs)(n.ul,{className:"contains-task-list",children:["\n",(0,i.jsxs)(n.li,{className:"task-list-item",children:[(0,i.jsx)(n.input,{type:"checkbox",disabled:!0})," ","Display clear pricing (including taxes)"]}),"\n",(0,i.jsxs)(n.li,{className:"task-list-item",children:[(0,i.jsx)(n.input,{type:"checkbox",disabled:!0})," ","Add terms of service"]}),"\n",(0,i.jsxs)(n.li,{className:"task-list-item",children:[(0,i.jsx)(n.input,{type:"checkbox",disabled:!0})," ","Add privacy policy"]}),"\n",(0,i.jsxs)(n.li,{className:"task-list-item",children:[(0,i.jsx)(n.input,{type:"checkbox",disabled:!0})," ","Add refund policy"]}),"\n",(0,i.jsxs)(n.li,{className:"task-list-item",children:[(0,i.jsx)(n.input,{type:"checkbox",disabled:!0})," ","Display cancellation terms for subscriptions"]}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"common-patterns",children:"Common Patterns"}),"\n",(0,i.jsx)(n.h3,{id:"check-subscription-status",children:"Check Subscription Status"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-typescript",children:"async function checkAccess(userId: string): Promise<boolean> {\n  const user = await db.users.findUnique({\n    where: { id: userId },\n    include: { subscription: true },\n  });\n\n  if (!user?.subscription) return false;\n\n  return (\n    user.subscription.status === 'active' ||\n    user.subscription.status === 'trialing'\n  );\n}\n"})}),"\n",(0,i.jsx)(n.h3,{id:"usage-based-billing",children:"Usage-Based Billing"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-typescript",children:"// Record usage\nawait stripe.subscriptionItems.createUsageRecord(\n  subscriptionItemId,\n  {\n    quantity: apiCallCount,\n    timestamp: Math.floor(Date.now() / 1000),\n    action: 'increment',\n  }\n);\n"})}),"\n",(0,i.jsx)(n.h3,{id:"proration-on-plan-changes",children:"Proration on Plan Changes"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-typescript",children:"// Upgrade subscription\nawait stripe.subscriptions.update(subscriptionId, {\n  items: [\n    {\n      id: existingItemId,\n      price: newPriceId,\n    },\n  ],\n  proration_behavior: 'create_prorations',\n});\n"})})]})}function p(e={}){const{wrapper:n}={...(0,r.R)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(d,{...e})}):d(e)}}}]);