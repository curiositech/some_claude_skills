"use strict";(globalThis.webpackChunkwebsite=globalThis.webpackChunkwebsite||[]).push([[14269],{28453:(e,n,s)=>{s.d(n,{R:()=>a,x:()=>c});var i=s(96540);const r={},t=i.createContext(r);function a(e){const n=i.useContext(t);return i.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function c(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:a(e.components),i.createElement(t.Provider,{value:n},e.children)}},28914:(e,n,s)=>{s.r(n),s.d(n,{assets:()=>l,contentTitle:()=>c,default:()=>u,frontMatter:()=>a,metadata:()=>i,toc:()=>d});const i=JSON.parse('{"id":"skills/supabase_admin/references/rls-patterns","title":"Advanced RLS Policy Patterns","description":"Policy Types","source":"@site/docs/skills/supabase_admin/references/rls-patterns.md","sourceDirName":"skills/supabase_admin/references","slug":"/skills/supabase_admin/references/rls-patterns","permalink":"/docs/skills/supabase_admin/references/rls-patterns","draft":false,"unlisted":false,"tags":[],"version":"current","sidebarPosition":1,"frontMatter":{"title":"Advanced RLS Policy Patterns","sidebar_label":"Advanced RLS Policy Patterns","sidebar_position":1}}');var r=s(74848),t=s(28453);const a={title:"Advanced RLS Policy Patterns",sidebar_label:"Advanced RLS Policy Patterns",sidebar_position:1},c="Advanced RLS Policy Patterns",l={},d=[{value:"Policy Types",id:"policy-types",level:2},{value:"Pattern 1: Owner-Based Access",id:"pattern-1-owner-based-access",level:2},{value:"Pattern 2: Public Read, Authenticated Write",id:"pattern-2-public-read-authenticated-write",level:2},{value:"Pattern 3: Role-Based Access Control (RBAC)",id:"pattern-3-role-based-access-control-rbac",level:2},{value:"Pattern 4: Team/Organization Access",id:"pattern-4-teamorganization-access",level:2},{value:"Pattern 5: Privacy Settings",id:"pattern-5-privacy-settings",level:2},{value:"Pattern 6: Temporal Access (Time-Based)",id:"pattern-6-temporal-access-time-based",level:2},{value:"Pattern 7: Hierarchical Access (Parent-Child)",id:"pattern-7-hierarchical-access-parent-child",level:2},{value:"Performance Optimization",id:"performance-optimization",level:2},{value:"Always Use Subquery for auth.uid()",id:"always-use-subquery-for-authuid",level:3},{value:"Index Policy Columns",id:"index-policy-columns",level:3},{value:"Use Security Definer Functions for Complex Logic",id:"use-security-definer-functions-for-complex-logic",level:3},{value:"Debugging Policies",id:"debugging-policies",level:2},{value:"Common Mistakes",id:"common-mistakes",level:2}];function o(e){const n={code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",ol:"ol",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",...(0,t.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(n.header,{children:(0,r.jsx)(n.h1,{id:"advanced-rls-policy-patterns",children:"Advanced RLS Policy Patterns"})}),"\n",(0,r.jsx)(n.h2,{id:"policy-types",children:"Policy Types"}),"\n",(0,r.jsxs)(n.table,{children:[(0,r.jsx)(n.thead,{children:(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.th,{children:"Type"}),(0,r.jsx)(n.th,{children:"Use Case"})]})}),(0,r.jsxs)(n.tbody,{children:[(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"FOR SELECT"})}),(0,r.jsx)(n.td,{children:"Read access"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"FOR INSERT"})}),(0,r.jsxs)(n.td,{children:["Create access (use ",(0,r.jsx)(n.code,{children:"WITH CHECK"}),")"]})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"FOR UPDATE"})}),(0,r.jsx)(n.td,{children:"Modify access"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"FOR DELETE"})}),(0,r.jsx)(n.td,{children:"Remove access"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"FOR ALL"})}),(0,r.jsx)(n.td,{children:"All operations"})]})]})]}),"\n",(0,r.jsx)(n.h2,{id:"pattern-1-owner-based-access",children:"Pattern 1: Owner-Based Access"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-sql",children:'-- Only owner can see/modify their data\nCREATE POLICY "Owner access" ON user_data\n  FOR ALL USING (auth.uid() = user_id);\n'})}),"\n",(0,r.jsx)(n.h2,{id:"pattern-2-public-read-authenticated-write",children:"Pattern 2: Public Read, Authenticated Write"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-sql",children:'-- Anyone can read\nCREATE POLICY "Public read" ON posts\n  FOR SELECT USING (true);\n\n-- Only authenticated users can create (owning their posts)\nCREATE POLICY "Auth write" ON posts\n  FOR INSERT WITH CHECK (\n    auth.role() = \'authenticated\'\n    AND auth.uid() = author_id\n  );\n\n-- Only author can update\nCREATE POLICY "Author update" ON posts\n  FOR UPDATE USING (auth.uid() = author_id);\n'})}),"\n",(0,r.jsx)(n.h2,{id:"pattern-3-role-based-access-control-rbac",children:"Pattern 3: Role-Based Access Control (RBAC)"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-sql",children:"-- Store roles in profiles\nALTER TABLE profiles ADD COLUMN role text DEFAULT 'user';\n\n-- Admin can do anything\nCREATE POLICY \"Admin full access\" ON content\n  FOR ALL USING (\n    EXISTS (\n      SELECT 1 FROM profiles\n      WHERE profiles.id = (SELECT auth.uid())\n        AND profiles.role = 'admin'\n    )\n  );\n\n-- Moderators can read and update\nCREATE POLICY \"Mod read\" ON content\n  FOR SELECT USING (\n    EXISTS (\n      SELECT 1 FROM profiles\n      WHERE profiles.id = (SELECT auth.uid())\n        AND profiles.role IN ('admin', 'moderator')\n    )\n  );\n"})}),"\n",(0,r.jsx)(n.h2,{id:"pattern-4-teamorganization-access",children:"Pattern 4: Team/Organization Access"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-sql",children:"-- Users belong to teams\nCREATE TABLE team_members (\n  team_id uuid REFERENCES teams(id),\n  user_id uuid REFERENCES profiles(id),\n  role text DEFAULT 'member',\n  PRIMARY KEY (team_id, user_id)\n);\n\n-- Team members can access team resources\nCREATE POLICY \"Team access\" ON team_resources\n  FOR SELECT USING (\n    EXISTS (\n      SELECT 1 FROM team_members\n      WHERE team_members.team_id = team_resources.team_id\n        AND team_members.user_id = (SELECT auth.uid())\n    )\n  );\n"})}),"\n",(0,r.jsx)(n.h2,{id:"pattern-5-privacy-settings",children:"Pattern 5: Privacy Settings"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-sql",children:"-- Users control their own visibility\nALTER TABLE profiles ADD COLUMN privacy text DEFAULT 'public';\n\nCREATE POLICY \"Respect privacy\" ON profiles\n  FOR SELECT USING (\n    privacy = 'public'\n    OR id = (SELECT auth.uid())\n    OR (\n      privacy = 'friends'\n      AND EXISTS (\n        SELECT 1 FROM friendships\n        WHERE status = 'accepted'\n          AND (\n            (requester_id = profiles.id AND addressee_id = (SELECT auth.uid()))\n            OR (addressee_id = profiles.id AND requester_id = (SELECT auth.uid()))\n          )\n      )\n    )\n  );\n"})}),"\n",(0,r.jsx)(n.h2,{id:"pattern-6-temporal-access-time-based",children:"Pattern 6: Temporal Access (Time-Based)"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-sql",children:'-- Content visible only during certain times\nCREATE POLICY "Time-limited access" ON events\n  FOR SELECT USING (\n    starts_at <= now()\n    AND (ends_at IS NULL OR ends_at > now())\n  );\n\n-- Soft-deleted items hidden\nCREATE POLICY "Hide deleted" ON posts\n  FOR SELECT USING (deleted_at IS NULL);\n'})}),"\n",(0,r.jsx)(n.h2,{id:"pattern-7-hierarchical-access-parent-child",children:"Pattern 7: Hierarchical Access (Parent-Child)"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-sql",children:"-- Comments inherit visibility from posts\nCREATE POLICY \"Comments follow posts\" ON comments\n  FOR SELECT USING (\n    EXISTS (\n      SELECT 1 FROM posts\n      WHERE posts.id = comments.post_id\n        AND (\n          posts.visibility = 'public'\n          OR posts.author_id = (SELECT auth.uid())\n        )\n    )\n  );\n"})}),"\n",(0,r.jsx)(n.h2,{id:"performance-optimization",children:"Performance Optimization"}),"\n",(0,r.jsx)(n.h3,{id:"always-use-subquery-for-authuid",children:"Always Use Subquery for auth.uid()"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-sql",children:'-- SLOW: JWT parsed for every row\nCREATE POLICY "slow" ON data\n  FOR SELECT USING (user_id = auth.uid());\n\n-- FAST: JWT parsed once\nCREATE POLICY "fast" ON data\n  FOR SELECT USING (user_id = (SELECT auth.uid()));\n'})}),"\n",(0,r.jsx)(n.h3,{id:"index-policy-columns",children:"Index Policy Columns"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-sql",children:"-- Create indexes on columns used in policies\nCREATE INDEX idx_posts_author ON posts(author_id);\nCREATE INDEX idx_team_members_lookup ON team_members(team_id, user_id);\nCREATE INDEX idx_profiles_role ON profiles(role);\n"})}),"\n",(0,r.jsx)(n.h3,{id:"use-security-definer-functions-for-complex-logic",children:"Use Security Definer Functions for Complex Logic"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-sql",children:'-- Move complex logic to a function\nCREATE OR REPLACE FUNCTION can_access_resource(resource_id uuid)\nRETURNS boolean AS $$\n  -- Complex access logic here\n  SELECT EXISTS (\n    SELECT 1 FROM permissions\n    WHERE permissions.resource_id = $1\n      AND permissions.user_id = (SELECT auth.uid())\n      AND permissions.expires_at > now()\n  );\n$$ LANGUAGE sql STABLE SECURITY DEFINER;\n\n-- Simple policy using function\nCREATE POLICY "Check permissions" ON resources\n  FOR SELECT USING (can_access_resource(id));\n'})}),"\n",(0,r.jsx)(n.h2,{id:"debugging-policies",children:"Debugging Policies"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-sql",children:'-- See all policies on a table\nSELECT * FROM pg_policies WHERE tablename = \'your_table\';\n\n-- Test as anonymous\nSET ROLE anon;\nSELECT * FROM your_table LIMIT 1;\nRESET ROLE;\n\n-- Test as authenticated with specific user\nSET request.jwt.claims TO \'{"sub": "user-uuid", "role": "authenticated"}\';\nSELECT * FROM your_table;\n\n-- Check current auth context\nSELECT\n  auth.uid() as user_id,\n  auth.role() as role,\n  current_user as db_user;\n'})}),"\n",(0,r.jsx)(n.h2,{id:"common-mistakes",children:"Common Mistakes"}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Forgetting to enable RLS"}),": ",(0,r.jsx)(n.code,{children:"ALTER TABLE t ENABLE ROW LEVEL SECURITY;"})]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Not indexing policy columns"}),": Causes full table scans"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsxs)(n.strong,{children:["Using ",(0,r.jsx)(n.code,{children:"auth.uid()"})," directly"]}),": Use ",(0,r.jsx)(n.code,{children:"(SELECT auth.uid())"})," instead"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Overly permissive policies"}),": Start restrictive, add permissions"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Circular references"}),": Policy A depends on B depends on A"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Missing INSERT policies"}),": ",(0,r.jsx)(n.code,{children:"WITH CHECK"})," is required for INSERT"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Testing only as superuser"}),": Superuser bypasses RLS"]}),"\n"]})]})}function u(e={}){const{wrapper:n}={...(0,t.R)(),...e.components};return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(o,{...e})}):o(e)}}}]);