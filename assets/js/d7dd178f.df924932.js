"use strict";(globalThis.webpackChunkwebsite=globalThis.webpackChunkwebsite||[]).push([[16070],{28453:(e,t,n)=>{n.d(t,{R:()=>i,x:()=>o});var r=n(96540);const s={},a=r.createContext(s);function i(e){const t=r.useContext(a);return r.useMemo(function(){return"function"==typeof e?e(t):{...t,...e}},[t,e])}function o(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:i(e.components),r.createElement(a.Provider,{value:t},e.children)}},44676:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>c,contentTitle:()=>o,default:()=>u,frontMatter:()=>i,metadata:()=>r,toc:()=>l});const r=JSON.parse('{"id":"skills/bot_developer/references/architecture-patterns","title":"Architecture Patterns","description":"Event-driven architecture and state machine patterns for production bots.","source":"@site/docs/skills/bot_developer/references/architecture-patterns.md","sourceDirName":"skills/bot_developer/references","slug":"/skills/bot_developer/references/architecture-patterns","permalink":"/docs/skills/bot_developer/references/architecture-patterns","draft":false,"unlisted":false,"tags":[],"version":"current","sidebarPosition":1,"frontMatter":{"title":"Architecture Patterns","sidebar_label":"Architecture Patterns","sidebar_position":1},"sidebar":"tutorialSidebar","previous":{"title":"Bot Developer","permalink":"/docs/skills/bot_developer/"},"next":{"title":"Moderation System","permalink":"/docs/skills/bot_developer/references/moderation-system"}}');var s=n(74848),a=n(28453);const i={title:"Architecture Patterns",sidebar_label:"Architecture Patterns",sidebar_position:1},o="Architecture Patterns",c={},l=[{value:"Event-Driven Bot Architecture",id:"event-driven-bot-architecture",level:2},{value:"State Machine for Conversations",id:"state-machine-for-conversations",level:2},{value:"Key Principles",id:"key-principles",level:2}];function d(e){const t={code:"code",h1:"h1",h2:"h2",header:"header",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",...(0,a.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(t.header,{children:(0,s.jsx)(t.h1,{id:"architecture-patterns",children:"Architecture Patterns"})}),"\n",(0,s.jsx)(t.p,{children:"Event-driven architecture and state machine patterns for production bots."}),"\n",(0,s.jsx)(t.h2,{id:"event-driven-bot-architecture",children:"Event-Driven Bot Architecture"}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{children:"                         \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n                         \u2502         Message Broker          \u2502\n                         \u2502   (Redis Streams / RabbitMQ)    \u2502\n                         \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n                                        \u2502\n        \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n        \u2502                               \u2502                               \u2502\n        \u25bc                               \u25bc                               \u25bc\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510              \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510              \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502  Command      \u2502              \u2502   Event       \u2502              \u2502  Scheduled    \u2502\n\u2502  Processor    \u2502              \u2502   Handler     \u2502              \u2502  Task Runner  \u2502\n\u2502               \u2502              \u2502               \u2502              \u2502               \u2502\n\u2502 /cmd parsing  \u2502              \u2502 on_message    \u2502              \u2502 cron jobs     \u2502\n\u2502 validation    \u2502              \u2502 on_reaction   \u2502              \u2502 reminders     \u2502\n\u2502 permissions   \u2502              \u2502 on_join       \u2502              \u2502 cleanups      \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518              \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518              \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n        \u2502                               \u2502                               \u2502\n        \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n                                        \u2502\n                                        \u25bc\n                         \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n                         \u2502        Service Layer            \u2502\n                         \u2502                                 \u2502\n                         \u2502  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510  \u2502\n                         \u2502  \u2502 User    \u2502  \u2502 Moderation  \u2502  \u2502\n                         \u2502  \u2502 Service \u2502  \u2502 Service     \u2502  \u2502\n                         \u2502  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518  \u2502\n                         \u2502  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510  \u2502\n                         \u2502  \u2502 Economy \u2502  \u2502 Integration \u2502  \u2502\n                         \u2502  \u2502 Service \u2502  \u2502 Service     \u2502  \u2502\n                         \u2502  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518  \u2502\n                         \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n                                        \u2502\n                                        \u25bc\n                         \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n                         \u2502        Data Layer               \u2502\n                         \u2502  PostgreSQL + Redis + S3        \u2502\n                         \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n"})}),"\n",(0,s.jsx)(t.h2,{id:"state-machine-for-conversations",children:"State Machine for Conversations"}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-python",children:'from enum import Enum, auto\nfrom typing import Callable, Optional\nimport asyncio\n\nclass State(Enum):\n    IDLE = auto()\n    AWAITING_CONFIRMATION = auto()\n    COLLECTING_INPUT = auto()\n    PROCESSING = auto()\n    ERROR = auto()\n\nclass ConversationStateMachine:\n    """\n    Finite state machine for managing multi-turn conversations.\n    Prevents race conditions and ensures clean state transitions.\n    """\n\n    def __init__(self, user_id: str, timeout: float = 300):\n        self.user_id = user_id\n        self.state = State.IDLE\n        self.context: dict = {}\n        self.timeout = timeout\n        self._timeout_task: Optional[asyncio.Task] = None\n        self._transitions: dict[tuple[State, str], tuple[State, Callable]] = {}\n\n    def register_transition(self, from_state: State, event: str,\n                           to_state: State, handler: Callable):\n        """Register a valid state transition."""\n        self._transitions[(from_state, event)] = (to_state, handler)\n\n    async def handle_event(self, event: str, data: dict) -> Optional[str]:\n        """Process event and execute transition if valid."""\n        key = (self.state, event)\n\n        if key not in self._transitions:\n            return f"Cannot {event} from state {self.state.name}"\n\n        to_state, handler = self._transitions[key]\n\n        # Cancel existing timeout\n        if self._timeout_task:\n            self._timeout_task.cancel()\n\n        # Execute handler\n        try:\n            result = await handler(self.context, data)\n            self.state = to_state\n\n            # Set new timeout if not idle\n            if to_state != State.IDLE:\n                self._timeout_task = asyncio.create_task(\n                    self._handle_timeout()\n                )\n\n            return result\n        except Exception as e:\n            self.state = State.ERROR\n            raise\n\n    async def _handle_timeout(self):\n        """Reset to IDLE after timeout."""\n        await asyncio.sleep(self.timeout)\n        self.state = State.IDLE\n        self.context = {}\n\n\n# Usage example: Moderation flow\nasync def setup_ban_flow(machine: ConversationStateMachine):\n    async def start_ban(ctx, data):\n        ctx[\'target_user\'] = data[\'target\']\n        ctx[\'reason\'] = data.get(\'reason\', \'No reason provided\')\n        return f"Confirm ban of {ctx[\'target_user\']}? (yes/no)"\n\n    async def confirm_ban(ctx, data):\n        if data[\'response\'].lower() == \'yes\':\n            await ban_user(ctx[\'target_user\'], ctx[\'reason\'])\n            return f"Banned {ctx[\'target_user\']}"\n        return "Ban cancelled"\n\n    async def cancel(ctx, data):\n        return "Operation cancelled"\n\n    machine.register_transition(State.IDLE, \'ban\', State.AWAITING_CONFIRMATION, start_ban)\n    machine.register_transition(State.AWAITING_CONFIRMATION, \'confirm\', State.IDLE, confirm_ban)\n    machine.register_transition(State.AWAITING_CONFIRMATION, \'cancel\', State.IDLE, cancel)\n'})}),"\n",(0,s.jsx)(t.h2,{id:"key-principles",children:"Key Principles"}),"\n",(0,s.jsxs)(t.ol,{children:["\n",(0,s.jsxs)(t.li,{children:[(0,s.jsx)(t.strong,{children:"Separation of concerns"}),": Commands, events, and scheduled tasks in separate processors"]}),"\n",(0,s.jsxs)(t.li,{children:[(0,s.jsx)(t.strong,{children:"Service layer"}),": Business logic isolated from platform-specific code"]}),"\n",(0,s.jsxs)(t.li,{children:[(0,s.jsx)(t.strong,{children:"State management"}),": Explicit states prevent race conditions in multi-turn interactions"]}),"\n",(0,s.jsxs)(t.li,{children:[(0,s.jsx)(t.strong,{children:"Timeout handling"}),": Auto-reset prevents stuck conversations"]}),"\n",(0,s.jsxs)(t.li,{children:[(0,s.jsx)(t.strong,{children:"Data layer abstraction"}),": PostgreSQL for persistence, Redis for caching/rate limits"]}),"\n"]})]})}function u(e={}){const{wrapper:t}={...(0,a.R)(),...e.components};return t?(0,s.jsx)(t,{...e,children:(0,s.jsx)(d,{...e})}):d(e)}}}]);