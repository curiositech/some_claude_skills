"use strict";(globalThis.webpackChunkwebsite=globalThis.webpackChunkwebsite||[]).push([[79493],{28453:(e,n,i)=>{i.d(n,{R:()=>l,x:()=>d});var s=i(96540);const r={},t=s.createContext(r);function l(e){const n=s.useContext(t);return s.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function d(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:l(e.components),s.createElement(t.Provider,{value:n},e.children)}},29782:(e,n,i)=>{i.r(n),i.d(n,{assets:()=>a,contentTitle:()=>d,default:()=>h,frontMatter:()=>l,metadata:()=>s,toc:()=>o});const s=JSON.parse('{"id":"skills/collage_layout_expert/references/implementation-guide","title":"Practical Implementation Guide","description":"Metal Shader Pipeline","source":"@site/docs/skills/collage_layout_expert/references/implementation-guide.md","sourceDirName":"skills/collage_layout_expert/references","slug":"/skills/collage_layout_expert/references/implementation-guide","permalink":"/docs/skills/collage_layout_expert/references/implementation-guide","draft":false,"unlisted":false,"tags":[],"version":"current","sidebarPosition":7,"frontMatter":{"title":"Practical Implementation Guide","sidebar_label":"Practical Implementation Guide","sidebar_position":7},"sidebar":"tutorialSidebar","previous":{"title":"David Hockney\'s Joiners Tec...","permalink":"/docs/skills/collage_layout_expert/references/hockney-technique"},"next":{"title":"Line Detection Algorithms (...","permalink":"/docs/skills/collage_layout_expert/references/line-detection"}}');var r=i(74848),t=i(28453);const l={title:"Practical Implementation Guide",sidebar_label:"Practical Implementation Guide",sidebar_position:7},d="Practical Implementation Guide",a={},o=[{value:"Metal Shader Pipeline",id:"metal-shader-pipeline",level:2},{value:"1. Edge Extraction",id:"1-edge-extraction",level:3},{value:"2. Line Detection (EDLines on GPU)",id:"2-line-detection-edlines-on-gpu",level:3},{value:"3. Color Histogram",id:"3-color-histogram",level:3},{value:"4. Poisson Blending",id:"4-poisson-blending",level:3},{value:"Core ML Integration",id:"core-ml-integration",level:2},{value:"Models Needed",id:"models-needed",level:3},{value:"Conversion",id:"conversion",level:3},{value:"Database Indexing",id:"database-indexing",level:2},{value:"HNSW for CLIP embeddings",id:"hnsw-for-clip-embeddings",level:3},{value:"Performance Targets",id:"performance-targets",level:2},{value:"Memory Management",id:"memory-management",level:2},{value:"Texture Compression",id:"texture-compression",level:3},{value:"Lazy Loading",id:"lazy-loading",level:3},{value:"Algorithm Selection Guide",id:"algorithm-selection-guide",level:2},{value:"Line Detection",id:"line-detection",level:3},{value:"Layout Strategy",id:"layout-strategy",level:3},{value:"Color Harmonization",id:"color-harmonization",level:3},{value:"Blending",id:"blending",level:3},{value:"Error Handling",id:"error-handling",level:2},{value:"Testing Strategies",id:"testing-strategies",level:2},{value:"Python Dependencies",id:"python-dependencies",level:2}];function c(e){const n={code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",hr:"hr",li:"li",ol:"ol",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,t.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(n.header,{children:(0,r.jsx)(n.h1,{id:"practical-implementation-guide",children:"Practical Implementation Guide"})}),"\n",(0,r.jsx)(n.h2,{id:"metal-shader-pipeline",children:"Metal Shader Pipeline"}),"\n",(0,r.jsx)(n.h3,{id:"1-edge-extraction",children:"1. Edge Extraction"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-metal",children:"kernel void extract_edge_region(\n    texture2d<float, access::read> image [[texture(0)]],\n    texture2d<float, access::write> edge_region [[texture(1)]],\n    constant EdgeParams& params [[buffer(0)]],\n    uint2 gid [[thread_position_in_grid]]\n) {\n    // Extract 10% strip along specified edge\n    // ...\n}\n"})}),"\n",(0,r.jsx)(n.h3,{id:"2-line-detection-edlines-on-gpu",children:"2. Line Detection (EDLines on GPU)"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-metal",children:"// Multi-pass: gradient \u2192 edge chains \u2192 line fitting\nkernel void compute_gradients(...);\nkernel void extract_edge_chains(...);\nkernel void fit_line_segments(...);\n"})}),"\n",(0,r.jsx)(n.h3,{id:"3-color-histogram",children:"3. Color Histogram"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-metal",children:"kernel void build_lab_histogram(\n    texture2d<float, access::read> lab_image [[texture(0)]],\n    device atomic_uint* histogram [[buffer(0)]],\n    uint2 gid [[thread_position_in_grid]]\n) {\n    float3 lab = lab_image.read(gid).rgb;\n\n    // Quantize to bins (8\xd78\xd78)\n    uint l_bin = uint(lab.x / 100.0 * 8.0);\n    uint a_bin = uint((lab.y + 128.0) / 256.0 * 8.0);\n    uint b_bin = uint((lab.z + 128.0) / 256.0 * 8.0);\n\n    uint bin_index = l_bin * 64 + a_bin * 8 + b_bin;\n    atomic_fetch_add_explicit(&histogram[bin_index], 1, memory_order_relaxed);\n}\n"})}),"\n",(0,r.jsx)(n.h3,{id:"4-poisson-blending",children:"4. Poisson Blending"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-metal",children:"kernel void poisson_jacobi_iteration(...);  // 50 iterations\n"})}),"\n",(0,r.jsx)(n.hr,{}),"\n",(0,r.jsx)(n.h2,{id:"core-ml-integration",children:"Core ML Integration"}),"\n",(0,r.jsx)(n.h3,{id:"models-needed",children:"Models Needed"}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"MobileSAM"})," (segmentation) - 5M params"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"CLIP ViT-B/32"})," (embeddings) - 150M params"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"MediaPipe Pose"})," (gesture detection) - 3M params"]}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"conversion",children:"Conversion"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-python",children:'import coremltools as ct\n\n# Convert PyTorch \u2192 Core ML\ntraced_model = torch.jit.trace(model, example_input)\nmlmodel = ct.convert(traced_model, inputs=[...])\nmlmodel.save("model.mlpackage")\n'})}),"\n",(0,r.jsx)(n.hr,{}),"\n",(0,r.jsx)(n.h2,{id:"database-indexing",children:"Database Indexing"}),"\n",(0,r.jsx)(n.h3,{id:"hnsw-for-clip-embeddings",children:"HNSW for CLIP embeddings"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-python",children:"import hnswlib\n\n# Initialize index\ndim = 512  # CLIP dimension\nindex = hnswlib.Index(space='cosine', dim=dim)\nindex.init_index(max_elements=10000, ef_construction=200, M=16)\n\n# Add embeddings\nfor i, embedding in enumerate(clip_embeddings):\n    index.add_items(embedding, i)\n\n# Query\nk = 50\nlabels, distances = index.knn_query(query_embedding, k=k)\n"})}),"\n",(0,r.jsx)(n.hr,{}),"\n",(0,r.jsx)(n.h2,{id:"performance-targets",children:"Performance Targets"}),"\n",(0,r.jsxs)(n.table,{children:[(0,r.jsx)(n.thead,{children:(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.th,{children:"Operation"}),(0,r.jsx)(n.th,{children:"Mac M2"}),(0,r.jsx)(n.th,{children:"iPhone 15 Pro"})]})}),(0,r.jsxs)(n.tbody,{children:[(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:"SAM segmentation (1024\xd71024)"}),(0,r.jsx)(n.td,{children:"0.5s"}),(0,r.jsx)(n.td,{children:"2s"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:"Edge extraction (100 shards)"}),(0,r.jsx)(n.td,{children:"1s"}),(0,r.jsx)(n.td,{children:"3s"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:"Line detection (EDLines, per photo)"}),(0,r.jsx)(n.td,{children:"10ms"}),(0,r.jsx)(n.td,{children:"20ms"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:"k-NN search (10k database)"}),(0,r.jsx)(n.td,{children:"<10ms"}),(0,r.jsx)(n.td,{children:"<50ms"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:"Greedy assembly (10-photo collage)"}),(0,r.jsx)(n.td,{children:"0.5s"}),(0,r.jsx)(n.td,{children:"2s"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:"Poisson blending (100 junctions)"}),(0,r.jsx)(n.td,{children:"2s"}),(0,r.jsx)(n.td,{children:"6s"})]})]})]}),"\n",(0,r.jsx)(n.hr,{}),"\n",(0,r.jsx)(n.h2,{id:"memory-management",children:"Memory Management"}),"\n",(0,r.jsx)(n.h3,{id:"texture-compression",children:"Texture Compression"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-swift",children:"let descriptor = MTLTextureDescriptor()\ndescriptor.pixelFormat = .bc7_rgbaUnorm  // 6:1 compression\n"})}),"\n",(0,r.jsx)(n.h3,{id:"lazy-loading",children:"Lazy Loading"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-swift",children:"// Store only feature vectors in memory\n// Load textures on-demand from disk\nclass ShardDatabase {\n    var features: [UUID: ShardFeatures]  // In memory\n    var texturePaths: [UUID: URL]        // On disk\n\n    func loadTexture(id: UUID) -> MTLTexture {\n        // Load PNG from disk when needed\n    }\n}\n"})}),"\n",(0,r.jsx)(n.hr,{}),"\n",(0,r.jsx)(n.h2,{id:"algorithm-selection-guide",children:"Algorithm Selection Guide"}),"\n",(0,r.jsx)(n.h3,{id:"line-detection",children:"Line Detection"}),"\n",(0,r.jsxs)(n.table,{children:[(0,r.jsx)(n.thead,{children:(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.th,{children:"Context"}),(0,r.jsx)(n.th,{children:"Recommended"})]})}),(0,r.jsxs)(n.tbody,{children:[(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:"Interactive generation"}),(0,r.jsx)(n.td,{children:"EDLines"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:"Final high-res render"}),(0,r.jsx)(n.td,{children:"LSD"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:"Teaching / legacy code"}),(0,r.jsx)(n.td,{children:"Hough"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:"Deep learning pipeline"}),(0,r.jsx)(n.td,{children:"LETR"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:"Mobile real-time"}),(0,r.jsx)(n.td,{children:"EDLines"})]})]})]}),"\n",(0,r.jsx)(n.h3,{id:"layout-strategy",children:"Layout Strategy"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Greedy Edge Growth"})," (MVP, Phase 4): Primary algorithm"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Hierarchical Clustering"}),": Essential optimization (50x speedup)"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Multi-Scale Matching"}),": Progressive refinement (10x speedup)"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Simulated Annealing"})," (Phase 6): Optional refinement"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Hockney Joiner Style"}),": User explicitly requests"]}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"color-harmonization",children:"Color Harmonization"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Optimal Transport"}),": Always use (mathematically principled)"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Affine Approximation"}),": Real-time preview (fast)"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Full Sinkhorn"}),": Final render (accurate)"]}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"blending",children:"Blending"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Poisson"}),": Seamless photographic junctions"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Alpha Feathering"}),": Simple overlaps, soft edges"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Diffusion Inpainting"}),": Poor-quality junctions (expensive)"]}),"\n"]}),"\n",(0,r.jsx)(n.hr,{}),"\n",(0,r.jsx)(n.h2,{id:"error-handling",children:"Error Handling"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-python",children:'def place_shard_safe(canvas, shard, position):\n    if canvas.would_overlap(shard, position):\n        raise PlacementError("Overlap detected")\n\n    if canvas.is_out_of_bounds(shard, position):\n        raise PlacementError("Out of bounds")\n\n    compatibility = canvas.check_neighbor_compatibility(shard, position)\n    if compatibility < 0.3:\n        logger.warning(f"Low compatibility: {compatibility:.2f}")\n\n    canvas.place(shard, position)\n'})}),"\n",(0,r.jsx)(n.hr,{}),"\n",(0,r.jsx)(n.h2,{id:"testing-strategies",children:"Testing Strategies"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-python",children:'def test_edge_alignment():\n    """Verify lines align across boundaries."""\n    photo1 = load_test_photo("horizon_left.jpg")\n    photo2 = load_test_photo("horizon_right.jpg")\n\n    edge1 = extract_edge_descriptor(photo1, \'right\')\n    edge2 = extract_edge_descriptor(photo2, \'left\')\n\n    assert len(edge1.lines) >= 1\n    assert len(edge2.lines) >= 1\n\n    angle_diff = abs(edge1.dominant_angle - edge2.dominant_angle)\n    assert angle_diff < 5.0\n\ndef test_hockney_style():\n    """Verify Hockney characteristics are present."""\n    collage = create_collage(photos, style=\'hockney_joiner\')\n\n    positions = [s.position for s in collage.shards]\n    irregularity = compute_grid_irregularity(positions)\n    assert 0.1 < irregularity < 0.2\n\n    rotations = [s.rotation for s in collage.shards]\n    assert np.std(rotations) > 1.0\n\n    overlaps = count_overlaps(collage)\n    assert overlaps > 0\n'})}),"\n",(0,r.jsx)(n.hr,{}),"\n",(0,r.jsx)(n.h2,{id:"python-dependencies",children:"Python Dependencies"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"pip install opencv-python numpy scipy scikit-image transformers pot hnswlib\n"})}),"\n",(0,r.jsxs)(n.table,{children:[(0,r.jsx)(n.thead,{children:(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.th,{children:"Package"}),(0,r.jsx)(n.th,{children:"Purpose"})]})}),(0,r.jsxs)(n.tbody,{children:[(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"opencv-python"})}),(0,r.jsx)(n.td,{children:"Line detection (EDLines, LSD), image processing"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"numpy"})}),(0,r.jsx)(n.td,{children:"Numerical computing, matrix operations"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"scipy"})}),(0,r.jsx)(n.td,{children:"Optimization, spatial algorithms"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"scikit-image"})}),(0,r.jsx)(n.td,{children:"Image processing, Poisson blending"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"transformers"})}),(0,r.jsx)(n.td,{children:"CLIP embeddings"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"pot"})}),(0,r.jsx)(n.td,{children:"Optimal transport (Wasserstein distance)"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"hnswlib"})}),(0,r.jsx)(n.td,{children:"Fast k-NN search"})]})]})]})]})}function h(e={}){const{wrapper:n}={...(0,t.R)(),...e.components};return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(c,{...e})}):c(e)}}}]);