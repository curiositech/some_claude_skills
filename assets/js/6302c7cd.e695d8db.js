"use strict";(globalThis.webpackChunkwebsite=globalThis.webpackChunkwebsite||[]).push([[87135],{16284:(e,n,s)=>{s.r(n),s.d(n,{assets:()=>d,contentTitle:()=>o,default:()=>u,frontMatter:()=>a,metadata:()=>i,toc:()=>E});const i=JSON.parse('{"id":"skills/supabase_admin/references/social-schema","title":"Social Features Schema Patterns","description":"Proven database patterns for social features in Supabase.","source":"@site/docs/skills/supabase_admin/references/social-schema.md","sourceDirName":"skills/supabase_admin/references","slug":"/skills/supabase_admin/references/social-schema","permalink":"/docs/skills/supabase_admin/references/social-schema","draft":false,"unlisted":false,"tags":[],"version":"current","sidebarPosition":2,"frontMatter":{"title":"Social Features Schema Patterns","sidebar_label":"Social Features Schema Patt...","sidebar_position":2}}');var r=s(74848),t=s(28453);const a={title:"Social Features Schema Patterns",sidebar_label:"Social Features Schema Patt...",sidebar_position:2},o="Social Features Schema Patterns",d={},E=[{value:"Friend/Connection System",id:"friendconnection-system",level:2},{value:"Basic Friend Request Schema",id:"basic-friend-request-schema",level:3},{value:"Query Helpers",id:"query-helpers",level:3},{value:"Sponsor/Sponsee Relationships",id:"sponsorsponsee-relationships",level:2},{value:"Hierarchical Mentor Relationship",id:"hierarchical-mentor-relationship",level:3},{value:"Accept Invite by Code",id:"accept-invite-by-code",level:3},{value:"Ad-Hoc Groups (Meeting-Based)",id:"ad-hoc-groups-meeting-based",level:2},{value:"Ephemeral Group Schema",id:"ephemeral-group-schema",level:3},{value:"Auto-Create Group for Meeting",id:"auto-create-group-for-meeting",level:3},{value:"Direct Messaging",id:"direct-messaging",level:2},{value:"Conversation Schema",id:"conversation-schema",level:3},{value:"Get or Create DM Conversation",id:"get-or-create-dm-conversation",level:3},{value:"Real-Time Subscriptions",id:"real-time-subscriptions",level:2},{value:"Performance Tips",id:"performance-tips",level:2}];function c(e){const n={code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",...(0,t.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(n.header,{children:(0,r.jsx)(n.h1,{id:"social-features-schema-patterns",children:"Social Features Schema Patterns"})}),"\n",(0,r.jsx)(n.p,{children:"Proven database patterns for social features in Supabase."}),"\n",(0,r.jsx)(n.h2,{id:"friendconnection-system",children:"Friend/Connection System"}),"\n",(0,r.jsx)(n.h3,{id:"basic-friend-request-schema",children:"Basic Friend Request Schema"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-sql",children:"-- Friend relationships (bidirectional once accepted)\nCREATE TABLE friendships (\n  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),\n  requester_id uuid REFERENCES profiles(id) ON DELETE CASCADE,\n  addressee_id uuid REFERENCES profiles(id) ON DELETE CASCADE,\n  status text CHECK (status IN ('pending', 'accepted', 'blocked')) DEFAULT 'pending',\n  created_at timestamptz DEFAULT now(),\n  updated_at timestamptz DEFAULT now(),\n  UNIQUE(requester_id, addressee_id)\n);\n\n-- Indexes for fast lookups\nCREATE INDEX idx_friendships_requester ON friendships(requester_id);\nCREATE INDEX idx_friendships_addressee ON friendships(addressee_id);\nCREATE INDEX idx_friendships_status ON friendships(status);\n\n-- RLS Policies\nALTER TABLE friendships ENABLE ROW LEVEL SECURITY;\n\nCREATE POLICY \"Users see their friendships\" ON friendships\n  FOR SELECT USING (\n    auth.uid() IN (requester_id, addressee_id)\n  );\n\nCREATE POLICY \"Users can request friendship\" ON friendships\n  FOR INSERT WITH CHECK (\n    auth.uid() = requester_id\n    AND requester_id != addressee_id\n  );\n\nCREATE POLICY \"Addressee can accept/reject\" ON friendships\n  FOR UPDATE USING (\n    auth.uid() = addressee_id\n    AND status = 'pending'\n  );\n\nCREATE POLICY \"Either party can delete\" ON friendships\n  FOR DELETE USING (\n    auth.uid() IN (requester_id, addressee_id)\n  );\n"})}),"\n",(0,r.jsx)(n.h3,{id:"query-helpers",children:"Query Helpers"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-sql",children:"-- Get all friends for a user (accepted only)\nCREATE OR REPLACE FUNCTION get_friends(user_uuid uuid)\nRETURNS TABLE(friend_id uuid, friend_since timestamptz) AS $$\n  SELECT\n    CASE\n      WHEN requester_id = user_uuid THEN addressee_id\n      ELSE requester_id\n    END as friend_id,\n    updated_at as friend_since\n  FROM friendships\n  WHERE status = 'accepted'\n    AND (requester_id = user_uuid OR addressee_id = user_uuid)\n$$ LANGUAGE sql STABLE;\n\n-- Check if two users are friends\nCREATE OR REPLACE FUNCTION are_friends(user1 uuid, user2 uuid)\nRETURNS boolean AS $$\n  SELECT EXISTS (\n    SELECT 1 FROM friendships\n    WHERE status = 'accepted'\n      AND ((requester_id = user1 AND addressee_id = user2)\n           OR (requester_id = user2 AND addressee_id = user1))\n  )\n$$ LANGUAGE sql STABLE;\n"})}),"\n",(0,r.jsx)(n.h2,{id:"sponsorsponsee-relationships",children:"Sponsor/Sponsee Relationships"}),"\n",(0,r.jsx)(n.h3,{id:"hierarchical-mentor-relationship",children:"Hierarchical Mentor Relationship"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-sql",children:"-- Sponsor relationships (one-to-many)\nCREATE TABLE sponsorships (\n  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),\n  sponsor_id uuid REFERENCES profiles(id) ON DELETE CASCADE,\n  sponsee_id uuid REFERENCES profiles(id) ON DELETE CASCADE,\n  invite_code text UNIQUE,\n  status text CHECK (status IN ('pending', 'active', 'ended')) DEFAULT 'pending',\n  program text, -- 'aa', 'na', 'cma', etc.\n  started_at timestamptz,\n  ended_at timestamptz,\n  created_at timestamptz DEFAULT now(),\n  UNIQUE(sponsor_id, sponsee_id)\n);\n\n-- Invite code generation function\nCREATE OR REPLACE FUNCTION generate_sponsor_invite()\nRETURNS TRIGGER AS $$\nBEGIN\n  IF NEW.invite_code IS NULL THEN\n    NEW.invite_code := upper(substr(md5(random()::text), 1, 8));\n  END IF;\n  RETURN NEW;\nEND;\n$$ LANGUAGE plpgsql;\n\nCREATE TRIGGER set_sponsor_invite\n  BEFORE INSERT ON sponsorships\n  FOR EACH ROW EXECUTE FUNCTION generate_sponsor_invite();\n\n-- RLS Policies\nALTER TABLE sponsorships ENABLE ROW LEVEL SECURITY;\n\nCREATE POLICY \"View own sponsorships\" ON sponsorships\n  FOR SELECT USING (auth.uid() IN (sponsor_id, sponsee_id));\n\nCREATE POLICY \"Sponsors create invites\" ON sponsorships\n  FOR INSERT WITH CHECK (auth.uid() = sponsor_id);\n\nCREATE POLICY \"Either party can update\" ON sponsorships\n  FOR UPDATE USING (auth.uid() IN (sponsor_id, sponsee_id));\n"})}),"\n",(0,r.jsx)(n.h3,{id:"accept-invite-by-code",children:"Accept Invite by Code"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-sql",children:"CREATE OR REPLACE FUNCTION accept_sponsor_invite(code text)\nRETURNS sponsorships AS $$\nDECLARE\n  result sponsorships;\nBEGIN\n  UPDATE sponsorships\n  SET\n    sponsee_id = auth.uid(),\n    status = 'active',\n    started_at = now(),\n    invite_code = NULL -- Clear code after use\n  WHERE invite_code = code\n    AND status = 'pending'\n    AND sponsee_id IS NULL\n  RETURNING * INTO result;\n\n  IF result IS NULL THEN\n    RAISE EXCEPTION 'Invalid or expired invite code';\n  END IF;\n\n  RETURN result;\nEND;\n$$ LANGUAGE plpgsql SECURITY DEFINER;\n"})}),"\n",(0,r.jsx)(n.h2,{id:"ad-hoc-groups-meeting-based",children:"Ad-Hoc Groups (Meeting-Based)"}),"\n",(0,r.jsx)(n.h3,{id:"ephemeral-group-schema",children:"Ephemeral Group Schema"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-sql",children:"-- Groups that form around meetings or topics\nCREATE TABLE groups (\n  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),\n  name text NOT NULL,\n  description text,\n  type text CHECK (type IN ('meeting', 'topic', 'support', 'private')) DEFAULT 'topic',\n  visibility text CHECK (visibility IN ('public', 'private', 'invite')) DEFAULT 'public',\n  meeting_id uuid REFERENCES meetings(id) ON DELETE SET NULL, -- Optional meeting link\n  creator_id uuid REFERENCES profiles(id) ON DELETE SET NULL,\n  max_members int DEFAULT 50,\n  expires_at timestamptz, -- For ephemeral groups\n  created_at timestamptz DEFAULT now()\n);\n\n-- Group membership\nCREATE TABLE group_members (\n  group_id uuid REFERENCES groups(id) ON DELETE CASCADE,\n  user_id uuid REFERENCES profiles(id) ON DELETE CASCADE,\n  role text CHECK (role IN ('owner', 'admin', 'member')) DEFAULT 'member',\n  joined_at timestamptz DEFAULT now(),\n  PRIMARY KEY (group_id, user_id)\n);\n\n-- Indexes\nCREATE INDEX idx_groups_meeting ON groups(meeting_id) WHERE meeting_id IS NOT NULL;\nCREATE INDEX idx_groups_type ON groups(type);\nCREATE INDEX idx_group_members_user ON group_members(user_id);\n\n-- RLS Policies\nALTER TABLE groups ENABLE ROW LEVEL SECURITY;\nALTER TABLE group_members ENABLE ROW LEVEL SECURITY;\n\nCREATE POLICY \"Public groups visible\" ON groups\n  FOR SELECT USING (\n    visibility = 'public'\n    OR creator_id = auth.uid()\n    OR EXISTS (\n      SELECT 1 FROM group_members\n      WHERE group_members.group_id = groups.id\n        AND group_members.user_id = auth.uid()\n    )\n  );\n\nCREATE POLICY \"Members see membership\" ON group_members\n  FOR SELECT USING (\n    user_id = auth.uid()\n    OR EXISTS (\n      SELECT 1 FROM group_members gm\n      WHERE gm.group_id = group_members.group_id\n        AND gm.user_id = auth.uid()\n    )\n  );\n"})}),"\n",(0,r.jsx)(n.h3,{id:"auto-create-group-for-meeting",children:"Auto-Create Group for Meeting"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-sql",children:"CREATE OR REPLACE FUNCTION create_meeting_group(\n  meeting_uuid uuid,\n  group_name text DEFAULT NULL\n)\nRETURNS groups AS $$\nDECLARE\n  meeting_record meetings;\n  new_group groups;\nBEGIN\n  -- Get meeting info\n  SELECT * INTO meeting_record FROM meetings WHERE id = meeting_uuid;\n\n  IF meeting_record IS NULL THEN\n    RAISE EXCEPTION 'Meeting not found';\n  END IF;\n\n  -- Create group\n  INSERT INTO groups (name, type, meeting_id, creator_id, expires_at)\n  VALUES (\n    COALESCE(group_name, meeting_record.name || ' Group'),\n    'meeting',\n    meeting_uuid,\n    auth.uid(),\n    now() + interval '24 hours' -- Ephemeral by default\n  )\n  RETURNING * INTO new_group;\n\n  -- Add creator as owner\n  INSERT INTO group_members (group_id, user_id, role)\n  VALUES (new_group.id, auth.uid(), 'owner');\n\n  RETURN new_group;\nEND;\n$$ LANGUAGE plpgsql SECURITY DEFINER;\n"})}),"\n",(0,r.jsx)(n.h2,{id:"direct-messaging",children:"Direct Messaging"}),"\n",(0,r.jsx)(n.h3,{id:"conversation-schema",children:"Conversation Schema"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-sql",children:"-- Conversations (1:1 or group)\nCREATE TABLE conversations (\n  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),\n  type text CHECK (type IN ('direct', 'group')) DEFAULT 'direct',\n  group_id uuid REFERENCES groups(id) ON DELETE CASCADE,\n  created_at timestamptz DEFAULT now()\n);\n\n-- Conversation participants\nCREATE TABLE conversation_participants (\n  conversation_id uuid REFERENCES conversations(id) ON DELETE CASCADE,\n  user_id uuid REFERENCES profiles(id) ON DELETE CASCADE,\n  last_read_at timestamptz DEFAULT now(),\n  muted_until timestamptz,\n  PRIMARY KEY (conversation_id, user_id)\n);\n\n-- Messages\nCREATE TABLE messages (\n  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),\n  conversation_id uuid REFERENCES conversations(id) ON DELETE CASCADE,\n  sender_id uuid REFERENCES profiles(id) ON DELETE SET NULL,\n  content text NOT NULL,\n  message_type text DEFAULT 'text', -- 'text', 'image', 'system'\n  created_at timestamptz DEFAULT now(),\n  edited_at timestamptz,\n  deleted_at timestamptz\n);\n\n-- Indexes\nCREATE INDEX idx_messages_conversation ON messages(conversation_id, created_at DESC);\nCREATE INDEX idx_conversation_participants_user ON conversation_participants(user_id);\n\n-- RLS Policies\nALTER TABLE conversations ENABLE ROW LEVEL SECURITY;\nALTER TABLE conversation_participants ENABLE ROW LEVEL SECURITY;\nALTER TABLE messages ENABLE ROW LEVEL SECURITY;\n\nCREATE POLICY \"Participants see conversations\" ON conversations\n  FOR SELECT USING (\n    EXISTS (\n      SELECT 1 FROM conversation_participants\n      WHERE conversation_participants.conversation_id = conversations.id\n        AND conversation_participants.user_id = auth.uid()\n    )\n  );\n\nCREATE POLICY \"Participants see messages\" ON messages\n  FOR SELECT USING (\n    EXISTS (\n      SELECT 1 FROM conversation_participants\n      WHERE conversation_participants.conversation_id = messages.conversation_id\n        AND conversation_participants.user_id = auth.uid()\n    )\n    AND deleted_at IS NULL\n  );\n\nCREATE POLICY \"Participants send messages\" ON messages\n  FOR INSERT WITH CHECK (\n    auth.uid() = sender_id\n    AND EXISTS (\n      SELECT 1 FROM conversation_participants\n      WHERE conversation_participants.conversation_id = messages.conversation_id\n        AND conversation_participants.user_id = auth.uid()\n    )\n  );\n"})}),"\n",(0,r.jsx)(n.h3,{id:"get-or-create-dm-conversation",children:"Get or Create DM Conversation"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-sql",children:"CREATE OR REPLACE FUNCTION get_or_create_dm(other_user_id uuid)\nRETURNS conversations AS $$\nDECLARE\n  existing_conversation conversations;\n  new_conversation conversations;\nBEGIN\n  -- Check for existing DM\n  SELECT c.* INTO existing_conversation\n  FROM conversations c\n  WHERE c.type = 'direct'\n    AND EXISTS (\n      SELECT 1 FROM conversation_participants cp1\n      WHERE cp1.conversation_id = c.id AND cp1.user_id = auth.uid()\n    )\n    AND EXISTS (\n      SELECT 1 FROM conversation_participants cp2\n      WHERE cp2.conversation_id = c.id AND cp2.user_id = other_user_id\n    )\n    AND (SELECT count(*) FROM conversation_participants WHERE conversation_id = c.id) = 2\n  LIMIT 1;\n\n  IF existing_conversation IS NOT NULL THEN\n    RETURN existing_conversation;\n  END IF;\n\n  -- Create new conversation\n  INSERT INTO conversations (type)\n  VALUES ('direct')\n  RETURNING * INTO new_conversation;\n\n  -- Add participants\n  INSERT INTO conversation_participants (conversation_id, user_id)\n  VALUES\n    (new_conversation.id, auth.uid()),\n    (new_conversation.id, other_user_id);\n\n  RETURN new_conversation;\nEND;\n$$ LANGUAGE plpgsql SECURITY DEFINER;\n"})}),"\n",(0,r.jsx)(n.h2,{id:"real-time-subscriptions",children:"Real-Time Subscriptions"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:"// Subscribe to new messages\nconst subscription = supabase\n  .channel('messages')\n  .on(\n    'postgres_changes',\n    {\n      event: 'INSERT',\n      schema: 'public',\n      table: 'messages',\n      filter: `conversation_id=eq.${conversationId}`\n    },\n    (payload) => {\n      addMessage(payload.new);\n    }\n  )\n  .subscribe();\n\n// Subscribe to friend requests\nconst friendRequests = supabase\n  .channel('friend-requests')\n  .on(\n    'postgres_changes',\n    {\n      event: 'INSERT',\n      schema: 'public',\n      table: 'friendships',\n      filter: `addressee_id=eq.${userId}`\n    },\n    (payload) => {\n      showNotification('New friend request!');\n    }\n  )\n  .subscribe();\n"})}),"\n",(0,r.jsx)(n.h2,{id:"performance-tips",children:"Performance Tips"}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.strong,{children:"Index foreign keys and filter columns"})}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsxs)(n.strong,{children:["Use ",(0,r.jsx)(n.code,{children:"(SELECT auth.uid())"})," in policies for JWT caching"]})}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.strong,{children:"Paginate messages with cursor-based pagination"})}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.strong,{children:"Consider materialized views for friend counts"})}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.strong,{children:"Use database functions for complex operations"})}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.strong,{children:"Clean up expired ephemeral groups with scheduled job"})}),"\n"]})]})}function u(e={}){const{wrapper:n}={...(0,t.R)(),...e.components};return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(c,{...e})}):c(e)}},28453:(e,n,s)=>{s.d(n,{R:()=>a,x:()=>o});var i=s(96540);const r={},t=i.createContext(r);function a(e){const n=i.useContext(t);return i.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function o(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:a(e.components),i.createElement(t.Provider,{value:n},e.children)}}}]);