"use strict";(globalThis.webpackChunkwebsite=globalThis.webpackChunkwebsite||[]).push([[96299],{28453:(e,n,t)=>{t.d(n,{R:()=>r,x:()=>a});var i=t(96540);const l={},o=i.createContext(l);function r(e){const n=i.useContext(o);return i.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function a(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(l):e.components||l:r(e.components),i.createElement(o.Provider,{value:n},e.children)}},76435:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>s,contentTitle:()=>a,default:()=>h,frontMatter:()=>r,metadata:()=>i,toc:()=>c});const i=JSON.parse('{"id":"skills/metal_shader_expert/references/pbr-shaders","title":"PBR Shader Implementation","description":"Complete Cook-Torrance BRDF implementation in Metal Shading Language.","source":"@site/docs/skills/metal_shader_expert/references/pbr-shaders.md","sourceDirName":"skills/metal_shader_expert/references","slug":"/skills/metal_shader_expert/references/pbr-shaders","permalink":"/docs/skills/metal_shader_expert/references/pbr-shaders","draft":false,"unlisted":false,"tags":[],"version":"current","sidebarPosition":3,"frontMatter":{"title":"PBR Shader Implementation","sidebar_label":"PBR Shader Implementation","sidebar_position":3},"sidebar":"tutorialSidebar","previous":{"title":"Noise-Based Effects","permalink":"/docs/skills/metal_shader_expert/references/noise-effects"},"next":{"title":"Vr Avatar Engineer","permalink":"/docs/skills/vr_avatar_engineer/"}}');var l=t(74848),o=t(28453);const r={title:"PBR Shader Implementation",sidebar_label:"PBR Shader Implementation",sidebar_position:3},a="PBR Shader Implementation",s={},c=[{value:"Material Properties Structure",id:"material-properties-structure",level:2},{value:"BRDF Components",id:"brdf-components",level:2},{value:"Fresnel-Schlick Approximation",id:"fresnel-schlick-approximation",level:3},{value:"GGX/Trowbridge-Reitz Normal Distribution",id:"ggxtrowbridge-reitz-normal-distribution",level:3},{value:"Smith&#39;s Schlick-GGX Geometry Function",id:"smiths-schlick-ggx-geometry-function",level:3},{value:"Complete PBR Lighting Function",id:"complete-pbr-lighting-function",level:2},{value:"Fragment Shader",id:"fragment-shader",level:2},{value:"Key Concepts",id:"key-concepts",level:2},{value:"Cook-Torrance BRDF",id:"cook-torrance-brdf",level:3},{value:"Energy Conservation",id:"energy-conservation",level:3},{value:"F0 Values",id:"f0-values",level:3},{value:"Half-Precision Optimization",id:"half-precision-optimization",level:2}];function d(e){const n={code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,o.R)(),...e.components};return(0,l.jsxs)(l.Fragment,{children:[(0,l.jsx)(n.header,{children:(0,l.jsx)(n.h1,{id:"pbr-shader-implementation",children:"PBR Shader Implementation"})}),"\n",(0,l.jsx)(n.p,{children:"Complete Cook-Torrance BRDF implementation in Metal Shading Language."}),"\n",(0,l.jsx)(n.h2,{id:"material-properties-structure",children:"Material Properties Structure"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-metal",children:"struct MaterialProperties {\n    float3 albedo;\n    float metallic;\n    float roughness;\n    float ao;           // Ambient occlusion\n    float3 emission;\n};\n\nstruct Light {\n    float3 position;\n    float3 color;\n    float intensity;\n};\n"})}),"\n",(0,l.jsx)(n.h2,{id:"brdf-components",children:"BRDF Components"}),"\n",(0,l.jsx)(n.h3,{id:"fresnel-schlick-approximation",children:"Fresnel-Schlick Approximation"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-metal",children:"float3 fresnel_schlick(float cos_theta, float3 F0) {\n    return F0 + (1.0 - F0) * pow(1.0 - cos_theta, 5.0);\n}\n"})}),"\n",(0,l.jsx)(n.h3,{id:"ggxtrowbridge-reitz-normal-distribution",children:"GGX/Trowbridge-Reitz Normal Distribution"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-metal",children:"float distribution_ggx(float3 N, float3 H, float roughness) {\n    float a = roughness * roughness;\n    float a2 = a * a;\n    float NdotH = max(dot(N, H), 0.0);\n    float NdotH2 = NdotH * NdotH;\n\n    float denom = (NdotH2 * (a2 - 1.0) + 1.0);\n    denom = M_PI_F * denom * denom;\n\n    return a2 / denom;\n}\n"})}),"\n",(0,l.jsx)(n.h3,{id:"smiths-schlick-ggx-geometry-function",children:"Smith's Schlick-GGX Geometry Function"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-metal",children:"float geometry_schlick_ggx(float NdotV, float roughness) {\n    float r = (roughness + 1.0);\n    float k = (r * r) / 8.0;\n\n    return NdotV / (NdotV * (1.0 - k) + k);\n}\n\nfloat geometry_smith(float3 N, float3 V, float3 L, float roughness) {\n    float NdotV = max(dot(N, V), 0.0);\n    float NdotL = max(dot(N, L), 0.0);\n    float ggx1 = geometry_schlick_ggx(NdotV, roughness);\n    float ggx2 = geometry_schlick_ggx(NdotL, roughness);\n\n    return ggx1 * ggx2;\n}\n"})}),"\n",(0,l.jsx)(n.h2,{id:"complete-pbr-lighting-function",children:"Complete PBR Lighting Function"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-metal",children:"float3 calculate_pbr_lighting(\n    float3 world_pos,\n    float3 normal,\n    float3 view_dir,\n    MaterialProperties material,\n    Light light\n) {\n    // Calculate light direction\n    float3 light_dir = normalize(light.position - world_pos);\n    float3 halfway = normalize(view_dir + light_dir);\n\n    // Distance attenuation\n    float distance = length(light.position - world_pos);\n    float attenuation = 1.0 / (distance * distance);\n    float3 radiance = light.color * light.intensity * attenuation;\n\n    // Cook-Torrance BRDF\n    float3 F0 = mix(float3(0.04), material.albedo, material.metallic);\n    float3 F = fresnel_schlick(max(dot(halfway, view_dir), 0.0), F0);\n\n    float NDF = distribution_ggx(normal, halfway, material.roughness);\n    float G = geometry_smith(normal, view_dir, light_dir, material.roughness);\n\n    float3 numerator = NDF * G * F;\n    float denominator = 4.0 * max(dot(normal, view_dir), 0.0) *\n                        max(dot(normal, light_dir), 0.0) + 0.0001;\n    float3 specular = numerator / denominator;\n\n    // Energy conservation\n    float3 kS = F;\n    float3 kD = (1.0 - kS) * (1.0 - material.metallic);\n\n    float NdotL = max(dot(normal, light_dir), 0.0);\n\n    return (kD * material.albedo / M_PI_F + specular) * radiance * NdotL;\n}\n"})}),"\n",(0,l.jsx)(n.h2,{id:"fragment-shader",children:"Fragment Shader"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-metal",children:"fragment float4 pbr_fragment(\n    VertexOut in [[stage_in]],\n    constant MaterialProperties& material [[buffer(0)]],\n    constant Light* lights [[buffer(1)]],\n    constant uint& light_count [[buffer(2)]],\n    constant float3& camera_pos [[buffer(3)]]\n) {\n    float3 normal = normalize(in.world_normal);\n    float3 view_dir = normalize(camera_pos - in.world_position);\n\n    // Accumulate lighting from all lights\n    float3 Lo = float3(0.0);\n    for (uint i = 0; i < light_count; i++) {\n        Lo += calculate_pbr_lighting(\n            in.world_position,\n            normal,\n            view_dir,\n            material,\n            lights[i]\n        );\n    }\n\n    // Ambient lighting (simplified IBL)\n    float3 ambient = float3(0.03) * material.albedo * material.ao;\n    float3 color = ambient + Lo + material.emission;\n\n    // HDR tone mapping (Reinhard)\n    color = color / (color + float3(1.0));\n\n    // Gamma correction\n    color = pow(color, float3(1.0/2.2));\n\n    return float4(color, 1.0);\n}\n"})}),"\n",(0,l.jsx)(n.h2,{id:"key-concepts",children:"Key Concepts"}),"\n",(0,l.jsx)(n.h3,{id:"cook-torrance-brdf",children:"Cook-Torrance BRDF"}),"\n",(0,l.jsxs)(n.p,{children:["The specular term: ",(0,l.jsx)(n.code,{children:"(D * G * F) / (4 * NdotV * NdotL)"})]}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.strong,{children:"D"}),": Normal Distribution Function (GGX)"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.strong,{children:"G"}),": Geometry Function (Smith)"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.strong,{children:"F"}),": Fresnel (Schlick approximation)"]}),"\n"]}),"\n",(0,l.jsx)(n.h3,{id:"energy-conservation",children:"Energy Conservation"}),"\n",(0,l.jsx)(n.p,{children:(0,l.jsx)(n.code,{children:"kD = (1 - kS) * (1 - metallic)"})}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:"Metals have no diffuse component"}),"\n",(0,l.jsx)(n.li,{children:"Total reflected energy never exceeds incoming"}),"\n"]}),"\n",(0,l.jsx)(n.h3,{id:"f0-values",children:"F0 Values"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:"Dielectrics: ~0.04 (plastic, fabric, skin)"}),"\n",(0,l.jsx)(n.li,{children:"Metals: Use albedo as F0"}),"\n",(0,l.jsx)(n.li,{children:(0,l.jsx)(n.code,{children:"F0 = mix(0.04, albedo, metallic)"})}),"\n"]}),"\n",(0,l.jsx)(n.h2,{id:"half-precision-optimization",children:"Half-Precision Optimization"}),"\n",(0,l.jsxs)(n.p,{children:["For mobile/Apple Silicon, convert to ",(0,l.jsx)(n.code,{children:"half"})," precision:"]}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-metal",children:"half3 fresnel_schlick_half(half cos_theta, half3 F0) {\n    return F0 + (half3(1.0h) - F0) * pow(1.0h - cos_theta, 5.0h);\n}\n"})}),"\n",(0,l.jsxs)(n.p,{children:["Only use ",(0,l.jsx)(n.code,{children:"float"})," for:"]}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:"World positions"}),"\n",(0,l.jsx)(n.li,{children:"Depth values"}),"\n",(0,l.jsx)(n.li,{children:"Cumulative calculations"}),"\n"]})]})}function h(e={}){const{wrapper:n}={...(0,o.R)(),...e.components};return n?(0,l.jsx)(n,{...e,children:(0,l.jsx)(d,{...e})}):d(e)}}}]);