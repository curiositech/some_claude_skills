"use strict";(globalThis.webpackChunkwebsite=globalThis.webpackChunkwebsite||[]).push([[13836],{28453:(e,n,s)=>{s.d(n,{R:()=>a,x:()=>l});var i=s(96540);const t={},r=i.createContext(t);function a(e){const n=i.useContext(r);return i.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function l(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(t):e.components||t:a(e.components),i.createElement(r.Provider,{value:n},e.children)}},92560:(e,n,s)=>{s.r(n),s.d(n,{assets:()=>d,contentTitle:()=>l,default:()=>u,frontMatter:()=>a,metadata:()=>i,toc:()=>o});const i=JSON.parse('{"id":"skills/drizzle_migrations/index","title":"\ud83d\udcca Drizzle Migrations","description":"Manage database schema with Drizzle ORM and SQLite migrations. Use when adding tables, modifying columns, creating indexes, or running migrations. Activates for database schema changes, migration generation, and Drizzle query patterns.","source":"@site/docs/skills/drizzle_migrations/index.md","sourceDirName":"skills/drizzle_migrations","slug":"/skills/drizzle_migrations/","permalink":"/docs/skills/drizzle_migrations/","draft":false,"unlisted":false,"tags":[],"version":"current","sidebarPosition":1,"frontMatter":{"sidebar_label":"Drizzle Migrations","sidebar_position":1}}');var t=s(74848),r=s(28453);const a={sidebar_label:"Drizzle Migrations",sidebar_position:1},l="\ud83d\udcca Drizzle Migrations",d={},o=[{value:"Allowed Tools",id:"allowed-tools",level:2},{value:"Tags",id:"tags",level:2},{value:"When to Use",id:"when-to-use",level:2},{value:"Project Setup",id:"project-setup",level:2},{value:"Schema Definition",id:"schema-definition",level:2},{value:"Table Definition",id:"table-definition",level:3},{value:"Relations",id:"relations",level:3},{value:"Column Types",id:"column-types",level:2},{value:"SQLite Types in Drizzle",id:"sqlite-types-in-drizzle",level:3},{value:"Migration Strategies",id:"migration-strategies",level:2},{value:"Strategy 1: Push (Development Only)",id:"strategy-1-push-development-only",level:3},{value:"Strategy 2: Generate &amp; Migrate (Production)",id:"strategy-2-generate--migrate-production",level:3},{value:"Applying Migrations in Code",id:"applying-migrations-in-code",level:3},{value:"Common Schema Changes",id:"common-schema-changes",level:2},{value:"Adding a New Table",id:"adding-a-new-table",level:3},{value:"Adding a Column",id:"adding-a-column",level:3},{value:"Adding an Index",id:"adding-an-index",level:3},{value:"Renaming (Requires Manual SQL)",id:"renaming-requires-manual-sql",level:3},{value:"Query Patterns",id:"query-patterns",level:2},{value:"Basic Queries",id:"basic-queries",level:3},{value:"Insert",id:"insert",level:3},{value:"Update",id:"update",level:3},{value:"Delete",id:"delete",level:3},{value:"Joins",id:"joins",level:3},{value:"Aggregations",id:"aggregations",level:3},{value:"Best Practices",id:"best-practices",level:2},{value:"References",id:"references",level:2}];function c(e){const n={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",hr:"hr",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,r.R)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(n.header,{children:(0,t.jsx)(n.h1,{id:"-drizzle-migrations",children:"\ud83d\udcca Drizzle Migrations"})}),"\n",(0,t.jsx)(n.p,{children:"Manage database schema with Drizzle ORM and SQLite migrations. Use when adding tables, modifying columns, creating indexes, or running migrations. Activates for database schema changes, migration generation, and Drizzle query patterns."}),"\n",(0,t.jsx)(n.hr,{}),"\n",(0,t.jsx)(n.h2,{id:"allowed-tools",children:"Allowed Tools"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:"Read, Write, Edit, Bash(npm:*, npx:*)\n"})}),"\n",(0,t.jsx)(n.h2,{id:"tags",children:"Tags"}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.code,{children:"database"})," ",(0,t.jsx)(n.code,{children:"drizzle"})," ",(0,t.jsx)(n.code,{children:"migrations"})]}),"\n",(0,t.jsx)(n.h1,{id:"drizzle-orm-migrations",children:"Drizzle ORM Migrations"}),"\n",(0,t.jsx)(n.p,{children:"This skill helps you manage database schema changes using Drizzle ORM with SQLite."}),"\n",(0,t.jsx)(n.h2,{id:"when-to-use",children:"When to Use"}),"\n",(0,t.jsxs)(n.p,{children:["\u2705 ",(0,t.jsx)(n.strong,{children:"USE this skill for:"})]}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"Adding new tables or modifying existing columns"}),"\n",(0,t.jsx)(n.li,{children:"Generating and running database migrations"}),"\n",(0,t.jsx)(n.li,{children:"Drizzle-specific query patterns and relations"}),"\n",(0,t.jsx)(n.li,{children:"SQLite schema best practices with Drizzle"}),"\n",(0,t.jsx)(n.li,{children:"Setting up Drizzle configuration"}),"\n"]}),"\n",(0,t.jsxs)(n.p,{children:["\u274c ",(0,t.jsx)(n.strong,{children:"DO NOT use for:"})]}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:["Supabase/PostgreSQL \u2192 use ",(0,t.jsx)(n.code,{children:"supabase-admin"})," skill"]}),"\n",(0,t.jsx)(n.li,{children:"Raw SQL without Drizzle \u2192 use standard SQL resources"}),"\n",(0,t.jsx)(n.li,{children:"Prisma ORM \u2192 different syntax and patterns"}),"\n",(0,t.jsx)(n.li,{children:"General database design theory \u2192 use database architecture resources"}),"\n"]}),"\n",(0,t.jsx)(n.h2,{id:"project-setup",children:"Project Setup"}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"Configuration"}),": ",(0,t.jsx)(n.code,{children:"drizzle.config.ts"})]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-typescript",children:"import { defineConfig } from 'drizzle-kit';\n\nexport default defineConfig({\n  schema: './src/db/schema.ts',\n  out: './drizzle',\n  dialect: 'sqlite',\n  dbCredentials: {\n    url: './data/app.db',\n  },\n});\n"})}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"Commands"}),":"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"npm run db:generate  # Generate migration files\nnpm run db:push      # Push schema directly (dev only)\nnpm run db:studio    # Open Drizzle Studio GUI\n"})}),"\n",(0,t.jsx)(n.h2,{id:"schema-definition",children:"Schema Definition"}),"\n",(0,t.jsxs)(n.p,{children:["Location: ",(0,t.jsx)(n.code,{children:"src/db/schema.ts"})]}),"\n",(0,t.jsx)(n.h3,{id:"table-definition",children:"Table Definition"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-typescript",children:"import { sqliteTable, text, integer, real, blob } from 'drizzle-orm/sqlite-core';\nimport { relations } from 'drizzle-orm';\n\n// Basic table\nexport const users = sqliteTable('users', {\n  id: text('id').primaryKey(),\n  email: text('email').notNull().unique(),\n  username: text('username').notNull(),\n  passwordHash: text('password_hash'),\n  createdAt: text('created_at').notNull().default(sql`CURRENT_TIMESTAMP`),\n  updatedAt: text('updated_at'),\n});\n\n// Table with foreign key\nexport const checkIns = sqliteTable('check_ins', {\n  id: text('id').primaryKey(),\n  userId: text('user_id').notNull().references(() => users.id, {\n    onDelete: 'cascade',\n  }),\n  mood: integer('mood').notNull(),\n  cravingLevel: integer('craving_level').notNull(),\n  sleepHours: real('sleep_hours'),\n  notes: text('notes'),\n  createdAt: text('created_at').notNull().default(sql`CURRENT_TIMESTAMP`),\n});\n\n// Table with composite index\nexport const auditLog = sqliteTable('audit_log', {\n  id: text('id').primaryKey(),\n  userId: text('user_id').notNull(),\n  action: text('action').notNull(),\n  targetType: text('target_type'),\n  targetId: text('target_id'),\n  details: text('details'),  // JSON string\n  createdAt: text('created_at').notNull().default(sql`CURRENT_TIMESTAMP`),\n}, (table) => ({\n  userActionIdx: index('idx_audit_user_action').on(table.userId, table.action),\n  createdAtIdx: index('idx_audit_created').on(table.createdAt),\n}));\n"})}),"\n",(0,t.jsx)(n.h3,{id:"relations",children:"Relations"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-typescript",children:"export const usersRelations = relations(users, ({ many }) => ({\n  checkIns: many(checkIns),\n  sessions: many(sessions),\n  journalEntries: many(journalEntries),\n}));\n\nexport const checkInsRelations = relations(checkIns, ({ one }) => ({\n  user: one(users, {\n    fields: [checkIns.userId],\n    references: [users.id],\n  }),\n}));\n"})}),"\n",(0,t.jsx)(n.h2,{id:"column-types",children:"Column Types"}),"\n",(0,t.jsx)(n.h3,{id:"sqlite-types-in-drizzle",children:"SQLite Types in Drizzle"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-typescript",children:"import {\n  sqliteTable,\n  text,           // TEXT - strings, JSON, dates\n  integer,        // INTEGER - numbers, booleans (0/1)\n  real,           // REAL - floating point\n  blob,           // BLOB - binary data\n} from 'drizzle-orm/sqlite-core';\n\nconst examples = sqliteTable('examples', {\n  // Strings\n  name: text('name').notNull(),\n  description: text('description'),\n\n  // Numbers\n  count: integer('count').notNull().default(0),\n  rating: real('rating'),\n\n  // Booleans (stored as 0/1)\n  isActive: integer('is_active', { mode: 'boolean' }).default(true),\n\n  // Dates (stored as ISO strings)\n  createdAt: text('created_at').notNull().default(sql`CURRENT_TIMESTAMP`),\n  expiresAt: text('expires_at'),\n\n  // JSON (stored as TEXT)\n  metadata: text('metadata', { mode: 'json' }),\n\n  // Enums (stored as TEXT)\n  status: text('status', { enum: ['pending', 'active', 'archived'] }),\n});\n"})}),"\n",(0,t.jsx)(n.h2,{id:"migration-strategies",children:"Migration Strategies"}),"\n",(0,t.jsx)(n.h3,{id:"strategy-1-push-development-only",children:"Strategy 1: Push (Development Only)"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"npm run db:push\n"})}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"Directly applies schema changes"}),"\n",(0,t.jsx)(n.li,{children:"Fast for development"}),"\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.strong,{children:"Never use in production"})}),"\n"]}),"\n",(0,t.jsx)(n.h3,{id:"strategy-2-generate--migrate-production",children:"Strategy 2: Generate & Migrate (Production)"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"# 1. Generate migration file\nnpm run db:generate\n\n# 2. Review generated SQL in /drizzle folder\n\n# 3. Apply migration (in code or manually)\n"})}),"\n",(0,t.jsx)(n.h3,{id:"applying-migrations-in-code",children:"Applying Migrations in Code"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-typescript",children:"import { drizzle } from 'drizzle-orm/better-sqlite3';\nimport { migrate } from 'drizzle-orm/better-sqlite3/migrator';\nimport Database from 'better-sqlite3';\n\nconst sqlite = new Database('./data/app.db');\nconst db = drizzle(sqlite);\n\n// Run migrations\nmigrate(db, { migrationsFolder: './drizzle' });\n"})}),"\n",(0,t.jsx)(n.h2,{id:"common-schema-changes",children:"Common Schema Changes"}),"\n",(0,t.jsx)(n.h3,{id:"adding-a-new-table",children:"Adding a New Table"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-typescript",children:"// 1. Add to schema.ts\nexport const newFeature = sqliteTable('new_feature', {\n  id: text('id').primaryKey(),\n  userId: text('user_id').notNull().references(() => users.id),\n  name: text('name').notNull(),\n  createdAt: text('created_at').notNull().default(sql`CURRENT_TIMESTAMP`),\n});\n\n// 2. Add relations\nexport const newFeatureRelations = relations(newFeature, ({ one }) => ({\n  user: one(users, {\n    fields: [newFeature.userId],\n    references: [users.id],\n  }),\n}));\n\n// 3. Generate migration\n// npm run db:generate\n"})}),"\n",(0,t.jsx)(n.h3,{id:"adding-a-column",children:"Adding a Column"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-typescript",children:"// In schema.ts, add the new column\nexport const users = sqliteTable('users', {\n  // existing columns...\n  newColumn: text('new_column'),  // Add this\n});\n\n// Generate migration\n// npm run db:generate\n"})}),"\n",(0,t.jsx)(n.h3,{id:"adding-an-index",children:"Adding an Index"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-typescript",children:"export const messages = sqliteTable('messages', {\n  id: text('id').primaryKey(),\n  conversationId: text('conversation_id').notNull(),\n  createdAt: text('created_at').notNull(),\n}, (table) => ({\n  // Add index\n  convCreatedIdx: index('idx_messages_conv_created')\n    .on(table.conversationId, table.createdAt),\n}));\n"})}),"\n",(0,t.jsx)(n.h3,{id:"renaming-requires-manual-sql",children:"Renaming (Requires Manual SQL)"}),"\n",(0,t.jsx)(n.p,{children:"SQLite doesn't support direct column renames in older versions. For complex changes:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-sql",children:"-- drizzle/XXXX_rename_column.sql\n-- Manual migration for column rename\n\n-- 1. Create new table with desired schema\nCREATE TABLE users_new (\n  id TEXT PRIMARY KEY,\n  email TEXT NOT NULL UNIQUE,\n  display_name TEXT NOT NULL,  -- renamed from username\n  created_at TEXT NOT NULL\n);\n\n-- 2. Copy data\nINSERT INTO users_new SELECT id, email, username, created_at FROM users;\n\n-- 3. Drop old table\nDROP TABLE users;\n\n-- 4. Rename new table\nALTER TABLE users_new RENAME TO users;\n"})}),"\n",(0,t.jsx)(n.h2,{id:"query-patterns",children:"Query Patterns"}),"\n",(0,t.jsx)(n.h3,{id:"basic-queries",children:"Basic Queries"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-typescript",children:"import { db } from '@/db';\nimport { eq, and, or, desc, asc, like, gte, lte } from 'drizzle-orm';\nimport { users, checkIns } from '@/db/schema';\n\n// Select all\nconst allUsers = await db.select().from(users);\n\n// Select with conditions\nconst activeUsers = await db\n  .select()\n  .from(users)\n  .where(eq(users.isActive, true));\n\n// Select specific columns\nconst userEmails = await db\n  .select({ id: users.id, email: users.email })\n  .from(users);\n\n// Complex where clause\nconst results = await db\n  .select()\n  .from(checkIns)\n  .where(\n    and(\n      eq(checkIns.userId, userId),\n      gte(checkIns.createdAt, startDate),\n      lte(checkIns.createdAt, endDate)\n    )\n  )\n  .orderBy(desc(checkIns.createdAt))\n  .limit(30);\n"})}),"\n",(0,t.jsx)(n.h3,{id:"insert",children:"Insert"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-typescript",children:"// Single insert\nconst [newUser] = await db\n  .insert(users)\n  .values({\n    id: generateId(),\n    email: 'user@example.com',\n    username: 'newuser',\n  })\n  .returning();\n\n// Bulk insert\nawait db.insert(checkIns).values([\n  { id: '1', userId, mood: 7, cravingLevel: 2 },\n  { id: '2', userId, mood: 8, cravingLevel: 1 },\n]);\n\n// Upsert (insert or update)\nawait db\n  .insert(users)\n  .values({ id: 'user-1', email: 'new@example.com' })\n  .onConflictDoUpdate({\n    target: users.id,\n    set: { email: 'new@example.com' },\n  });\n"})}),"\n",(0,t.jsx)(n.h3,{id:"update",children:"Update"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-typescript",children:"await db\n  .update(users)\n  .set({ username: 'newname', updatedAt: new Date().toISOString() })\n  .where(eq(users.id, userId));\n"})}),"\n",(0,t.jsx)(n.h3,{id:"delete",children:"Delete"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-typescript",children:"// Always use WHERE clause!\nawait db\n  .delete(checkIns)\n  .where(eq(checkIns.id, checkInId));\n\n// Delete with multiple conditions\nawait db\n  .delete(sessions)\n  .where(\n    and(\n      eq(sessions.userId, userId),\n      lte(sessions.expiresAt, new Date().toISOString())\n    )\n  );\n"})}),"\n",(0,t.jsx)(n.h3,{id:"joins",children:"Joins"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-typescript",children:"const userWithCheckIns = await db\n  .select({\n    user: users,\n    checkIn: checkIns,\n  })\n  .from(users)\n  .leftJoin(checkIns, eq(users.id, checkIns.userId))\n  .where(eq(users.id, userId));\n"})}),"\n",(0,t.jsx)(n.h3,{id:"aggregations",children:"Aggregations"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-typescript",children:"import { count, avg, sum, max, min } from 'drizzle-orm';\n\nconst stats = await db\n  .select({\n    totalCheckIns: count(),\n    avgMood: avg(checkIns.mood),\n    maxStreak: max(checkIns.streak),\n  })\n  .from(checkIns)\n  .where(eq(checkIns.userId, userId));\n"})}),"\n",(0,t.jsx)(n.h2,{id:"best-practices",children:"Best Practices"}),"\n",(0,t.jsxs)(n.ol,{children:["\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.strong,{children:"Always use transactions for related changes"})}),"\n"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-typescript",children:"await db.transaction(async (tx) => {\n  await tx.insert(users).values(userData);\n  await tx.insert(profiles).values(profileData);\n});\n"})}),"\n",(0,t.jsxs)(n.ol,{start:"2",children:["\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.strong,{children:"Always include WHERE on DELETE/UPDATE"})}),"\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.strong,{children:"Use indexes for frequently queried columns"})}),"\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.strong,{children:"Store dates as ISO strings for SQLite"})}),"\n",(0,t.jsx)(n.li,{children:(0,t.jsxs)(n.strong,{children:["Use ",(0,t.jsx)(n.code,{children:"returning()"})," to get inserted/updated rows"]})}),"\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.strong,{children:"Generate migrations, don't push to production"})}),"\n"]}),"\n",(0,t.jsx)(n.h2,{id:"references",children:"References"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.a,{href:"https://orm.drizzle.team/docs/overview",children:"Drizzle ORM Docs"})}),"\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.a,{href:"https://orm.drizzle.team/docs/get-started-sqlite",children:"Drizzle SQLite"})}),"\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.a,{href:"https://orm.drizzle.team/docs/migrations",children:"Drizzle Migrations"})}),"\n"]})]})}function u(e={}){const{wrapper:n}={...(0,r.R)(),...e.components};return n?(0,t.jsx)(n,{...e,children:(0,t.jsx)(c,{...e})}):c(e)}}}]);