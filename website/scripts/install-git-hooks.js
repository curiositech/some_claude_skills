#!/usr/bin/env node
const fs = require('fs');
const path = require('path');

const HOOK_SCRIPT = `#!/bin/bash
# Auto-generated by site-reliability-engineer & skill-documentarian skills
# Regenerate with: cd website && npm run install-hooks

echo "üîç Running pre-commit validation..."

# Get staged files by type
STAGED_MD=$(git diff --cached --name-only --diff-filter=ACM | grep '\\.md$' || true)
STAGED_TS=$(git diff --cached --name-only --diff-filter=ACM | grep 'skills\\.ts$' || true)
STAGED_SKILLS=$(git diff --cached --name-only --diff-filter=ACMD | grep '^\\.claude/skills/' || true)
STAGED_SKILL_MD=$(git diff --cached --name-only --diff-filter=ACM | grep '^\\.claude/skills/.*\\.md$' || true)
STAGED_README=$(git diff --cached --name-only --diff-filter=ACM | grep '^README\\.md$' || true)
STAGED_AGENTS=$(git diff --cached --name-only --diff-filter=ACM | grep '^\\.claude/agents/.*\\.md$' || true)

# Get project root
PROJECT_ROOT="$(git rev-parse --show-toplevel)"

# ========================================
# FORGE: Agent Validation
# ========================================
if [ -n "$STAGED_AGENTS" ]; then
  VALIDATOR="$PROJECT_ROOT/scripts/validate_agent.py"

  if [ -f "$VALIDATOR" ]; then
    echo "üèõÔ∏è Validating Founding Council agents..."
    AGENT_ERRORS=0

    for file in $STAGED_AGENTS; do
      # Skip uppercase files like FOUNDING_COUNCIL.md
      BASENAME=$(basename "$file" .md)
      BASENAME_UPPER=$(echo "$BASENAME" | tr '[:lower:]' '[:upper:]')
      if [ "$BASENAME" = "$BASENAME_UPPER" ]; then
        continue
      fi

      FULL_PATH="$PROJECT_ROOT/$file"
      echo -n "  Checking $file... "

      if OUTPUT=$(python3 "$VALIDATOR" "$FULL_PATH" 2>&1); then
        if echo "$OUTPUT" | grep -q "‚ùå FAIL"; then
          echo "‚ùå FAIL"
          echo "$OUTPUT" | grep -E "(ERROR|‚ùå)" | head -5
          AGENT_ERRORS=$((AGENT_ERRORS + 1))
        else
          echo "‚úì"
        fi
      else
        echo "‚ùå FAIL"
        echo "$OUTPUT" | head -5
        AGENT_ERRORS=$((AGENT_ERRORS + 1))
      fi
    done

    if [ $AGENT_ERRORS -gt 0 ]; then
      echo "‚ùå Agent validation failed. Run: python3 scripts/validate_agent.py <agent-file>"
      exit 1
    fi
    echo "‚úÖ Agent validation passed"
  else
    echo "‚ö†Ô∏è Agent validator not found at $VALIDATOR, skipping agent validation"
  fi
fi

# Check for README.md or skill folder changes (README validation)
if [ -n "$STAGED_README" ] || [ -n "$STAGED_SKILLS" ]; then
  echo "üìñ Validating README.md skill count..."
  cd website || exit 1
  node scripts/validate-readme.js || exit 1
  cd ..
fi

# Check for skills.ts changes (badge validation)
if [ -n "$STAGED_TS" ]; then
  echo "üè∑Ô∏è Validating skill badges..."
  cd website || exit 1
  node scripts/validate-badges.js || exit 1
  cd ..
fi

# Check for skill folder changes (metadata regeneration + doc sync)
if [ -n "$STAGED_SKILLS" ]; then
  echo "üñºÔ∏è Validating hero images..."
  cd website || exit 1
  node scripts/validate-hero-images.js || exit 1
  cd ..

  echo "üìä Regenerating skill metadata..."
  cd website || exit 1

  # Regenerate metadata
  npx tsx scripts/generateSkillMetadata.ts || {
    echo "‚ùå Failed to regenerate skill metadata"
    exit 1
  }

  # Add the regenerated metadata to the commit if it changed
  if [ -n "$(git diff src/data/skillMetadata.json 2>/dev/null)" ]; then
    echo "üìù Adding updated skillMetadata.json to commit..."
    git add src/data/skillMetadata.json
  fi

  # Sync skill documentation
  echo "üìÑ Syncing skill documentation..."
  npx tsx scripts/syncSkillDocs.ts || {
    echo "‚ùå Failed to sync skill documentation"
    exit 1
  }

  # Add any updated doc files to the commit
  if [ -n "$(git diff docs/skills/*.md 2>/dev/null)" ]; then
    echo "üìù Adding updated skill docs to commit..."
    git add docs/skills/*.md
  fi

  # Regenerate OG image with updated skill count
  echo "üñºÔ∏è Regenerating OG image..."
  bash scripts/generate-og-image.sh || {
    echo "‚ùå Failed to regenerate OG image"
    exit 1
  }

  # Add the regenerated OG image to the commit if it changed
  if [ -n "$(git diff static/img/og-image.png 2>/dev/null)" ]; then
    echo "üìù Adding updated og-image.png to commit..."
    git add static/img/og-image.png
  fi

  cd ..
fi

# Validate skill folder markdown files for angle brackets
if [ -n "$STAGED_SKILL_MD" ]; then
  echo "üìê Validating skill markdown files for angle brackets..."
  cd website || exit 1
  for file in $STAGED_SKILL_MD; do
    if [ -f "../$file" ]; then
      node scripts/validate-brackets.js "../$file" || exit 1
    fi
  done
  cd ..
fi

if [ -z "$STAGED_MD" ]; then
  echo "‚úÖ No markdown files to validate"
  exit 0
fi

echo "üìù Validating $STAGED_MD..."

# Change to website directory
cd website || exit 1

# Run validations on staged files (convert to relative paths)
for file in $STAGED_MD; do
  # Skip if file doesn't exist (deleted files)
  if [ ! -f "../$file" ]; then
    continue
  fi

  # Skip artifact documentation files (not processed as MDX)
  if [[ "$file" == *"src/data/artifacts/"* ]]; then
    continue
  fi

  # Validate each file
  node scripts/validate-liquid.js "../$file" || exit 1
  node scripts/validate-brackets.js "../$file" || exit 1

  # Only validate skill prop if it's a skill doc
  if [[ "$file" == *"docs/skills/"* ]]; then
    node scripts/validate-skill-props.js "../$file" || exit 1
  fi
done

# ========================================
# SYNC SKILLS/AGENTS TO USER-LEVEL CONFIG
# ========================================
# Always sync skills and agents to user-level Claude Code config
# This ensures the user's Claude Code has access to all repo skills/agents
if [ -n "$STAGED_SKILLS" ] || [ -n "$STAGED_AGENTS" ]; then
  SYNC_SCRIPT="$PROJECT_ROOT/scripts/sync-skills-to-user.sh"
  if [ -f "$SYNC_SCRIPT" ]; then
    echo ""
    bash "$SYNC_SCRIPT" || {
      echo "‚ö†Ô∏è Warning: Failed to sync skills/agents to user config (non-fatal)"
    }
  fi
fi

echo "‚úÖ Pre-commit validation passed"
exit 0
`;

// Resolve paths
const projectRoot = path.resolve(__dirname, '../..');
const hookPath = path.join(projectRoot, '.git/hooks/pre-commit');
const hooksDir = path.dirname(hookPath);

// Check if .git/hooks directory exists
if (!fs.existsSync(hooksDir)) {
  console.error('‚ùå Error: .git/hooks directory not found');
  console.error('   Are you in a git repository?');
  process.exit(1);
}

// Write hook
try {
  fs.writeFileSync(hookPath, HOOK_SCRIPT, { mode: 0o755 });
  console.log('‚úÖ Installed pre-commit hook at .git/hooks/pre-commit');
} catch (error) {
  console.error('‚ùå Failed to install hook:', error.message);
  process.exit(1);
}

console.log('\nüéâ Hook installation complete!');
console.log('\nValidation will run automatically on git commit');
console.log('Test manually with: cd website && npm run validate:all');
